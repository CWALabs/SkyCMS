@model Sky.Editor.Models.Blogs.BlogStreamViewModel
@{
    ViewData["Title"] = "Create Blog Stream";
}
<h2>Create Blog Stream</h2>
<div class="container">
    <div class="row align-content-center">
        <div class="col-md-6 text-light">
            <form asp-action="Create" method="post" id="createBlogForm" novalidate>
                <div class="mb-3">
                    <label asp-for="BlogKey" class="form-label">What is the name of your blog?</label>
                    <input asp-for="BlogKey" class="form-control" autocomplete="off" aria-describedby="blogKeyHelp blogKeyFeedback" />
                    <div id="blogKeyHelp" class="form-text">
                        Tips: Use a short, descriptive title (3–60 chars). Letters, numbers, and hyphens only. Avoid special characters and extra words like "the", "a", "my".
                    </div>
                    <div id="blogKeyFeedback" class="mt-1 small" aria-live="polite"></div>
                    <span asp-validation-for="BlogKey" class="text-danger"></span>
                </div>
                <button type="submit" class="btn btn-primary">Create</button>
                <a class="btn btn-secondary" href="@Url.Action("Index")">Cancel</a>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Inline JavaScript validation for BlogKey -->
    <script>
        /*
            PSEUDOCODE / PLAN (in comments to satisfy assistant spec):
            - Grab elements: input(BlogKey), form, feedback div.
            - Define reserved words list and regex rules.
            - slugify(raw):
                * to lowercase
                * replace & with 'and'
                * remove apostrophes
                * replace non-alphanumeric with hyphen
                * collapse multiple hyphens
                * trim hyphens
            - validate():
                * Get raw value.
                * If empty -> message: please enter.
                * Produce slugCandidate via slugify.
                * Check:
                    length (3-60),
                    allowed pattern: ^[a-z][a-z0-9-]*$,
                    no consecutive hyphens (already handled),
                    not start/end with hyphen,
                    not in reserved list,
                    not all digits.
                * Build an array of issues.
                * If slugCandidate differs from raw and slugCandidate valid -> show suggestion button.
                * Assign classes: add is-invalid if issues > 0 else is-valid.
                * Return object { valid, slugCandidate }.
            - On input: live validate (debounced).
            - On blur: immediate validate.
            - On suggestion click: replace value with suggestion and revalidate.
            - On form submit: final validate; prevent submit if invalid; focus input.
        */
        (function () {
            const input = document.getElementById('BlogKey');
            const form = document.getElementById('createBlogForm');
            const feedback = document.getElementById('blogKeyFeedback');

            if (!input || !feedback) return;

            const RESERVED = new Set(['admin','root','system','blog','blogs','post','posts','api','new','create','edit','delete']);
            let debounceTimer;

            function slugify(raw) {
                return raw
                    .toLowerCase()
                    .replace(/&/g, ' and ')
                    .replace(/['’`"]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '');
            }

            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, c => ({
                    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
                }[c]));
            }

            function validate(showAll = true) {
                const raw = input.value.trim();
                const slugCandidate = slugify(raw);
                const issues = [];

                if (!raw.length) {
                    issues.push('Please enter a title for your blog.');
                }

                if (slugCandidate.length && (slugCandidate.length < 3 || slugCandidate.length > 60)) {
                    issues.push('Title (URL key) should be between 3 and 60 characters after cleanup.');
                }

                if (slugCandidate && !/^[a-z][a-z0-9-]*$/.test(slugCandidate)) {
                    issues.push('Must start with a letter and contain only lowercase letters, numbers, and hyphens.');
                }

                if (slugCandidate && /--/.test(slugCandidate)) {
                    issues.push('Avoid consecutive hyphens.');
                }

                if (slugCandidate && (slugCandidate.startsWith('-') || slugCandidate.endsWith('-'))) {
                    issues.push('Cannot start or end with a hyphen.');
                }

                if (slugCandidate && RESERVED.has(slugCandidate)) {
                    issues.push('That word is reserved. Please choose something more specific.');
                }

                if (slugCandidate && /^[0-9]+$/.test(slugCandidate)) {
                    issues.push('Title should not be only numbers.');
                }

                // Build feedback HTML
                const messages = [];

                if (issues.length) {
                    messages.push('<div class="text-danger fw-semibold mb-1">Please fix:</div>');
                    messages.push('<ul class="mb-1 ps-3">' + issues.map(i => '<li>' + escapeHtml(i) + '</li>').join('') + '</ul>');
                } else if (raw.length) {
                    messages.push('<div class="text-success">Looks good. This will appear at /' + escapeHtml(slugCandidate) + '</div>');
                }

                // Suggestion if difference and no major issues except normalization
                const significantDifference = raw && slugCandidate && raw !== slugCandidate;
                const slugValid = !issues.length || (issues.length === 1 && issues[0].startsWith('Title (URL key) should be between')); // allow length message separately
                if (significantDifference && slugValid) {
                    messages.push(
                        '<div class="mt-1">' +
                        'Suggestion: <button type="button" class="btn btn-sm btn-outline-secondary" id="applySlugBtn" ' +
                        'aria-label="Apply suggested URL friendly title">' + escapeHtml(slugCandidate) + '</button>' +
                        '</div>'
                    );
                }

                // Extra guidance (only if not valid)
                if (issues.length && showAll) {
                    messages.push(
                        '<div class="mt-2 small text-muted">' +
                        '<strong>Hints:</strong> Keep it short (e.g., tech-notes, garden-journal). Avoid filler words. ' +
                        'Use hyphens to separate meaningful words.' +
                        '</div>'
                    );
                }

                feedback.innerHTML = messages.join('') || '';
                input.classList.toggle('is-invalid', issues.length > 0);
                input.classList.toggle('is-valid', issues.length === 0 && raw.length > 0);

                // Attach suggestion button handler if present
                setTimeout(() => {
                    const btn = document.getElementById('applySlugBtn');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            input.value = slugCandidate;
                            validate();
                            input.focus();
                        }, { once: true });
                    }
                }, 0);

                return { valid: issues.length === 0, slugCandidate };
            }

            function debouncedValidate() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => validate(false), 180);
            }

            input.addEventListener('input', debouncedValidate);
            input.addEventListener('blur', () => validate());

            form.addEventListener('submit', (e) => {
                const { valid } = validate();
                if (!valid) {
                    e.preventDefault();
                    input.focus();
                }
            });

            // Initial pass (in case of server re-display)
            validate(false);
        })();
    </script>
    <style>
        /* Small inline enhancements */
        #blogKeyFeedback .btn-outline-secondary {
            line-height: 1;
        }
        input.is-valid {
            border-color: #198754;
        }
        input.is-invalid {
            border-color: #dc3545;
        }
    </style>
}
