@using Newtonsoft.Json
@model EditCodePostModel
@{
    Layout = "_LayoutEditor";
    ViewData["Title"] = $"Editing '{Model.Title}' with the Code Editor.";
    var fields = Model.EditorFields.ToArray();
    var aclass = "active";
    var hasPermissionsSet = Model.ArticlePermissions.Any();
}

<style>
    /* Set menu options */
    #btnCcmsCodeEditor,
    #liBtnVersions {
        display: none !important;
    }
</style>

<nav id="navBar" class="code-tabs navbar" style="display:none">
    <ul class="nav nav-tabs" id="nav-tab">
        @{
            foreach (var field in fields)
            {
                <li class="nav-item">
                    <a class="code-tabs nav-link @aclass" title="@field.ToolTip" data-bs-toggle="tooltip" data-bs-placement="bottom" data-ccms-fieldname="@field.FieldName" aria-current="page">@field.FieldName</a>
                </li>
                aclass = "";
            }
        }
    </ul>
</nav>

<div id="editspace" class="m-editor-container" style="display:none"></div>

<form id="frmSave" asp-action="EditCode">
    <input type="hidden" asp-for="Id" value="@Model.Id" />
    <input type="hidden" asp-for="SaveAsNewVersion" />
    <input type="hidden" asp-for="VersionNumber" />
    <input type="hidden" asp-for="ArticleNumber" />
    <input type="hidden" asp-for="EditingField" />
    <input type="hidden" asp-for="Content" />
    <input type="hidden" asp-for="Title" />
    <input type="hidden" asp-for="Published" />
    <input type="hidden" asp-for="Updated" />
    <input type="hidden" asp-for="RoleList" />
    <input type="hidden" asp-for="UrlPath" />
    <input type="hidden" asp-for="IsValid" />
    <input type="hidden" asp-for="HeadJavaScript" />
    <input type="hidden" asp-for="FooterJavaScript" />
    <input type="hidden" asp-for="EditorType" />
    <input type="hidden" asp-for="UpdateExisting" />
    <input type="hidden" asp-for="BannerImage" />
</form>

<!-- Load shared scripts -->
<script src="~/lib/monaco-editor/min/vs/loader.min.js"></script>
<script src="~/js/editors/monaco-editor-core.js"></script>
<script src="~/js/editors/monaco-editor-insert-helpers.js"></script>

@if (Model != null)
{
    <div class="modal" id="versionList" tabindex="-2">
        <div class="modal-dialog">
            <div class="modal-header">
                <h5 class="modal-title">Article Versions</h5>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
}


<script>
    // View-specific constants
    var fieldName;
    const versionNumber = @Model.VersionNumber;
    const ccms_editor_userid = "@this.Context.User.Identity.Name";
    const hasModel = @((Model != null).ToString().ToLower());
    var hasPermissionsSet = @hasPermissionsSet.ToString().ToLower();
    
    // Initialize editFields from model
    var editFields = @Html.Raw(JsonConvert.SerializeObject(Model.EditorFields));

    // Override afterEditorCreate to add custom behavior
    function afterEditorCreate(fieldInfo) {
        // Allow user interaction
        $.unblockUI();
        
        // Check after loading data
        checkDisplayLiveEditorButton('Content');
    }

    // View-specific save function
    function saveChanges(postProcessing) {
        if (validatePermissions() === false) {
            return;
        }

        if (saveInProgress === true) {
            return;
        }

        saveInProgress = true;
        saving();
        savePublishDateTime();

        if (editor) {
            $("#" + fieldId).val(editor.getValue());
        }

        let model = {
            Id: $("#Id").val(),
            SaveAsNewVersion: $("#SaveAsNewVersion").val(),
            ArticleNumber: $("#ArticleNumber").val(),
            VersionNumber: $("#VersionNumber").val(),
            Title: $("#Title").val(),
            RoleList: $("#RoleList").val(),
            Published: "",
            Updated: $("#Updated").val(),
            Content: encryptData($("#Content").val()),
            HeadJavaScript: encryptData($("#HeadJavaScript").val()),
            FooterJavaScript: encryptData($("#FooterJavaScript").val()),
            EditingField: $("#EditingField").val(),
            UrlPath: $("#UrlPath").val(),
            EditorType: $("#EditorType").val(),
            UpdateExisting: $("#UpdateExisting").val(),
            BannerImage: $("#BannerImage").val()
        };

        $.post("/Editor/EditCode", model, function (response) {
            saveInProgress = false;
            doneSaving();

            if (response.IsValid) {
                checkDisplayLiveEditorButton('Content');
                if (next !== null && typeof next === 'function') {
                    next();
                    next = null;
                }
            } else {
                var errorMsg = "Error(s):";
                $.each(response.Errors, function (index, error) {
                    errorMsg = "<p>" + error.Key + "</p><ul>";
                    $.each(error.Errors, function (index, innerError) {
                        errorMsg = errorMsg + "<li>" + innerError.Exception.Message + "</li>";
                    });
                    errorMsg = errorMsg + "</ul>";
                });
                $("#divErrorLog").html(errorMsg);
                var errorModal = new bootstrap.Modal(document.getElementById('modalSavingError'));
                errorModal.show();
            }
        }).fail(function (xhr, status, error) {
            saveInProgress = false;
            doneSaving();
            $("#divErrorLog").html(xhr.responseText);
            errorModal.show();
        });
    }

    $(document).ready(function () {
        // Block user action until loaded
        $.blockUI();

        // Initialize common Monaco editor functionality
        initializeMonacoEditor({
            initialField: "@Model.EditingField",
            autoSaveDelay: 3500,
            readOnly: false
        });

        // View-specific initialization
        $("#btnOtherPages").show();
        $("#btnOpenInsertImage").hide();
        $("#lblTitle").html("Page URL: ");
        $("#modalChgTitleHeader").html("Change page URL: ");
        $("#newTitle").html("New page URL: ");

        if ($("#UrlPath").val() != "root") {
            $("#divUrlTitleExamples").show();
        }
        
        $("#spanWorkingVersionNo").html("Working Version: " + versionNumber);
        $("#navBar").show();
        $("#editspace").show();
        $("#liBtnVersions").show();
        $("#divTitleGroup").show();
        $("#liInsert").show();
        $("#btnVersions").attr("href", "/Editor/Versions/" + $("#ArticleNumber").val() + "?versionNumber=" + $("#VersionNumber").val());

        // Setup insert button handlers
        setupInsertButtonHandlers();

        if (hasModel && isReviewer === false && isAuthor === false && requiresAuthentication) {
            $(".perm").show();
        }

        $("#btnCcmsGrapesJsEditor").show();
    });

    $(document).on("unload", function () {
        if (typeof fileMgrPopup !== "undefined" && fileMgrPopup !== null && fileMgrPopup.location) {
            fileMgrPopup.close();
        }
    });
</script>