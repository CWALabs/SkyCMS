@using Newtonsoft.Json
@model LayoutCodeViewModel
@{
    Layout = "_LayoutEditor";
    ViewData["Title"] = Model.EditorTitle;
    var readOnly = (bool?)ViewData["ReadOnly"] ?? false;
}

<!-- Use shared partial for common editor UI -->
<partial name="_CodeEditorShared" model="Model" />

<form id="frmSave" asp-action="EditCode">
    <input type="hidden" asp-for="Id"/>
    <input type="hidden" asp-for="EditingField"/>
    <input type="hidden" asp-for="Head"/>
    <input type="hidden" asp-for="HtmlHeader"/>
    <input type="hidden" asp-for="FooterHtmlContent" />
    <input type="hidden" asp-for="EditorType" />
</form>

<script src="~/js/editors/monaco-editor-common.js"></script>

<script>
    // View-specific constants
    const readOnly = @readOnly.ToString().ToLower();

    // Initialize code editor with Layouts-specific configuration
    const editorApi = initializeCodeEditor({
        initialField: "@Model.EditingField",
        autoSaveDelay: 1500,
        readOnly: readOnly
    });

    // Register Layouts-specific save handler
    editorApi.registerSaveHandler(function(myModal) {
        if (readOnly) {
            return;
        }

        if (window.saveInProgress === true) {
            return;
        }

        window.saveInProgress = true;
        saving();

        if (typeof myModal !== "undefined" && myModal !== null) {
            myModal.hide();
        }
        
        savePublishDateTime();
        $("#Title").val($("#tbTitle").val());

        // Prepare model with encrypted data
        let model = prepareEncryptedModel('#frmSave', 
            ['Head', 'HtmlHeader', 'FooterHtmlContent']);

        $.post("/Layouts/EditCode", model, function(response) {
            handleSaveResponse(response);
        }).fail(handleSaveFailure);
    });

    $(document).ready(function() {
        // Layouts-specific initialization
        $("#liInsert").show();
        $("#tbTitle").val("@Model.EditorTitle");
        $("#btnSaveAsDraft").hide();

        // Setup common UI elements
        setupCommonEditorUI();

        // Hide the navigation bar if in read-only mode
        if (readOnly) {
            $("#navbarSupportedContent").hide();
        }
    });

    // Setup cleanup
    setupEditorCleanup();
</script>
