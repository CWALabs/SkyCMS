@using Newtonsoft.Json
@model LayoutCodeViewModel
@{
    Layout = "_LayoutEditor";
    ViewData["Title"] = Model.EditorTitle;
    var readOnly = (bool?)ViewData["ReadOnly"] ?? false;
}

<!-- Use shared partial for common editor UI -->
<partial name="_CodeEditorShared" model="Model" />

<form id="frmSave" asp-action="EditCode">
    <input type="hidden" asp-for="Id"/>
    <input type="hidden" asp-for="EditingField"/>
    <input type="hidden" asp-for="Head"/>
    <input type="hidden" asp-for="HtmlHeader"/>
    <input type="hidden" asp-for="FooterHtmlContent" />
    <input type="hidden" asp-for="EditorType" />
    <input type="hidden" asp-for="Publish" />
</form>

<script>
    // View-specific constants
    var fieldName;
    const readOnly = @readOnly.ToString().ToLower();
    const ccms_editor_userid = "@this.Context.User.Identity.Name";
    const hasModel = @((Model != null).ToString().ToLower());
    var hasPermissionsSet = false;
    
    // Initialize editFields from model
    var editFields = @Html.Raw(JsonConvert.SerializeObject(Model.EditorFields));

    // Override afterEditorCreate to add Layouts-specific behavior
    function afterEditorCreate(fieldInfo) {
        // Update active document tracker
        if (window.activeDocumentTracker) {
            window.activeDocumentTracker.setActiveDocument({
                fieldName: fieldInfo.FieldName,
                language: fieldInfo.EditorMode,
                title: '@Model.EditorTitle',
                layoutId: '@Model.Id',
                isDirty: false
            });
        }
        
        // Check after loading data
        if (typeof checkDisplayLiveEditorButton === 'function') {
            checkDisplayLiveEditorButton('Content');
        }
    }

    // View-specific save function
    function saveChanges(postProcessing) {
        if (readOnly) {
            return;
        }

        if (window.saveInProgress === true) {
            return;
        }

        window.saveInProgress = true;
        
        if (typeof showSaving === 'function') {
            showSaving();
        }
        
        if (typeof savePublishDateTime === 'function') {
            savePublishDateTime();
        }
        
        $("#Title").val($("#tbTitle").val());

        // Save current editor content
        if (window.monacoEditorCore) {
            window.monacoEditorCore.saveCurrentFieldContent();
        } else if (window.editor && window.fieldId) {
            $("#" + window.fieldId).val(window.editor.getValue());
        }

        // Prepare model with encrypted data
        let model = {
            Id: $("#Id").val(),
            EditingField: $("#EditingField").val(),
            Head: encryptData($("#Head").val()),
            HtmlHeader: encryptData($("#HtmlHeader").val()),
            FooterHtmlContent: encryptData($("#FooterHtmlContent").val()),
            EditorType: $("#EditorType").val(),
            Publish: $("#Publish").val(),
        };

        $.post("/Layouts/EditCode", model, function(response) {
            window.saveInProgress = false;
            
            if (typeof doneSaving === 'function') {
                doneSaving();
            }

            if (response.IsValid) {
                // Mark document as clean after successful save
                if (window.activeDocumentTracker) {
                    window.activeDocumentTracker.markClean();
                }
                
                if (typeof postProcessing !== 'undefined' && postProcessing !== null && typeof postProcessing === 'function') {
                    postProcessing();
                }
                
                toastMsg("Layout saved successfully.");

                if (typeof next !== 'undefined' && next !== null && typeof next === 'function') {
                    next();
                    next = null;
                }

            } else {
                var errorMsg = "<h5>Error(s) detected while saving:</h5>";
                $.each(response.Errors, function (index, error) {
                    errorMsg += "<p>" + error.Key + "</p><ul>";
                    $.each(error.Errors, function (index, innerError) {
                        errorMsg += "<li>" + (innerError.Exception ? innerError.Exception.Message : innerError.ErrorMessage) + "</li>";
                    });
                    errorMsg += "</ul>";
                });
                $("#divErrorLog").html(errorMsg);
                
                if (typeof bootstrap !== 'undefined' && document.getElementById('modalSavingError')) {
                    var errorModal = new bootstrap.Modal(document.getElementById('modalSavingError'));
                    errorModal.show();
                }
            }
        }).fail(function (xhr, status, error) {
            window.saveInProgress = false;
            
            if (typeof doneSaving === 'function') {
                doneSaving();
            }
            
            $("#divErrorLog").html(xhr.responseText);
            
            if (typeof bootstrap !== 'undefined' && document.getElementById('modalSavingError')) {
                var errorModal = new bootstrap.Modal(document.getElementById('modalSavingError'));
                errorModal.show();
            }
        });
    }

    // Add listener for active document changes
    if (window.activeDocumentTracker) {
        window.activeDocumentTracker.addListener((docInfo) => {
            console.log('Active document changed:', docInfo);
        });
    }

    $(document).ready(async function () {
        try {
            // Block user action until loaded
            if (typeof $.blockUI === 'function') {
                $.blockUI();
            }

            // Initialize Monaco editor with modern loader
            await initializeMonacoEditor({
                editFields: editFields,
                initialField: "@Model.EditingField",
                autoSaveDelay: 3500,
                readOnly: readOnly,
                basePath: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min'
            });
            
            // Close loading spinner and display saved status
            $("#spinLoading").hide();
            
            // View-specific initialization
            $("#liInsert").show();
            $("#tbTitle").val("@Model.EditorTitle");
            $("#btnSaveAsDraft").hide();
            $("#navBar").show();
            $("#editspace").show();

            // Hide the navigation bar if in read-only mode
            if (readOnly) {
                $("#navbarSupportedContent").hide();
            }

        } catch (error) {
            console.error('Failed to initialize editor:', error);
            
            if (typeof $.unblockUI === 'function') {
                $.unblockUI();
            }
            
            alert('Failed to load editor. Please refresh the page and try again.\n\nError: ' + error.message);
        }
    });

    $(document).on("unload", function () {
        // Cleanup editor
        if (window.monacoEditorCore) {
            window.monacoEditorCore.dispose();
        }

        // Cleanup file manager popup
        if (typeof fileMgrPopup !== "undefined" && fileMgrPopup !== null && fileMgrPopup.location) {
            fileMgrPopup.close();
        }
    });
</script>
