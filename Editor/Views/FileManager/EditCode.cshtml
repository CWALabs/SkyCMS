@model FileManagerEditCodeViewModel
@using Newtonsoft.Json
@using System.IO
@{
    Layout = "_LayoutEditor";
    ViewData["Title"] = Model.EditorTitle;
}

<!-- Use shared partial for common editor UI -->
<partial name="_CodeEditorShared" model="Model" />

<form id="frmSave" asp-action="EditCode" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="EditingField" />
    <input type="hidden" asp-for="Content" />
    <input type="hidden" asp-for="Path" />
    <input type="hidden" asp-for="EditorMode" />
    <input type="hidden" asp-for="EditorTitle" />
    <input type="hidden" asp-for="EditorFields" />
    <input type="hidden" asp-for="EditorType" />
</form>

<script src="~/js/editors/monaco-editor-common.js"></script>

<script>
    // Initialize code editor with FileManager-specific configuration
    const editorApi = initializeCodeEditor({
        initialField: "@Model.EditingField",
        autoSaveDelay: 1500,
        readOnly: false,
        blockUIOnLoad: true,
        onBeforeInit: function() {
            // Disable title and publishing fields for file manager
            $("#tbTitle").prop("disabled", true);
            $("#tbPublished").prop("disabled", true);
        },
        onAfterInit: function() {
            $.unblockUI();
            checkDisplayLiveEditorButton('Content');
        }
    });

    // Register FileManager-specific save handler
    editorApi.registerSaveHandler(function(myModal, next) {
        if (!validateEditorPermissions() || window.saveInProgress === true) {
            return;
        }

        window.saveInProgress = true;
        saving();
        savePublishDateTime();

        if (typeof myModal !== "undefined" && myModal !== null) {
            myModal.hide();
        }
        
        $("#Title").val($("#tbTitle").val());

        // Get form data
        var form = $('#frmSave');
        
        if (window.editor && window.fieldId) {
            $("#" + window.fieldId).val(encryptData(window.editor.getValue()));
        }

        $.post("@Url.Action("EditCode")", form.serialize(), function(response) {
            handleSaveResponse(response,
                function() {
                    // Success callback
                    if (typeof next !== "undefined" && next !== null) {
                        next();
                    }
                }
            );
        }).fail(handleSaveFailure);
    });

    $(document).ready(function() {
        // FileManager-specific initialization
        $("#btnSaveAsDraft").hide();
        
        // Setup common UI elements
        setupCommonEditorUI();
    });

    // Setup cleanup
    setupEditorCleanup();
</script>