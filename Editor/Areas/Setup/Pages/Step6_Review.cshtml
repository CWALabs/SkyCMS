@page
@model Sky.Editor.Areas.Setup.Pages.Step6_Review
@{
    ViewData["Title"] = "Review & Complete";
    Layout = "_LayoutSetup";
}

@await Html.PartialAsync("_SetupStepIndicator", 6)

<h2>Review Configuration</h2>
<p class="text-muted text-light">Please review your settings before completing the setup</p>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @Model.ErrorMessage
    </div>
}

@if (Model.Config != null)
{
    <!-- Storage Configuration -->
    <div class="card mb-3 bg-secondary text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-database"></i> Storage</h5>
            <a href="@Url.Page("./Step1_Storage")" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">Connection String:</dt>
                <dd class="col-sm-8">
                    <code class="text-muted">@(string.IsNullOrEmpty(Model.Config.StorageConnectionString) ? "Not configured" : "������������")</code>
                    @if (!string.IsNullOrEmpty(Model.Config.StorageConnectionString))
                    {
                        <span class="badge bg-success ms-2">Configured</span>
                    }
                </dd>
                <dt class="col-sm-4">Public URL:</dt>
                <dd class="col-sm-8">@Model.Config.BlobPublicUrl</dd>
            </dl>
        </div>
    </div>

    <!-- Administrator Account -->
    <div class="card mb-3 bg-secondary text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-user-shield"></i> Administrator</h5>
            <a href="@Url.Page("./Step2_AdminAccount")" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">Email:</dt>
                <dd class="col-sm-8">@Model.Config.AdminEmail</dd>
                <dt class="col-sm-4">Password:</dt>
                <dd class="col-sm-8">
                    <code class="text-muted">������������</code>
                    <span class="badge bg-success ms-2">Set</span>
                </dd>
            </dl>
        </div>
    </div>

    <!-- Publisher Configuration -->
    <div class="card mb-3 bg-secondary text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-globe"></i> Publisher</h5>
            <a href="@Url.Page("./Step3_Publisher")" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">Publisher URL:</dt>
                <dd class="col-sm-8">
                    <a href="@Model.Config.PublisherUrl" target="_blank" class="text-light">
                        @Model.Config.PublisherUrl <i class="fas fa-external-link-alt"></i>
                    </a>
                </dd>
                <dt class="col-sm-4">Static Website Mode:</dt>
                <dd class="col-sm-8">
                    @if (Model.Config.StaticWebPages)
                    {
                        <span class="badge bg-info">Enabled</span>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark">Disabled</span>
                    }
                </dd>
                <dt class="col-sm-4">Requires Authentication:</dt>
                <dd class="col-sm-8">
                    @if (Model.Config.CosmosRequiresAuthentication)
                    {
                        <span class="badge bg-warning text-dark">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-success">No</span>
                    }
                </dd>
                <dt class="col-sm-4">Allowed File Types:</dt>
                <dd class="col-sm-8">
                    <code class="text-muted">@Model.Config.AllowedFileTypes</code>
                </dd>
            </dl>
        </div>
    </div>

    <!-- Email Configuration -->
    <div class="card mb-3 bg-secondary text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-envelope"></i> Email</h5>
            <a href="@Url.Page("./Step4_Email")" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            @{
                var hasEmail = !string.IsNullOrEmpty(Model.Config.SendGridApiKey) ||
                               !string.IsNullOrEmpty(Model.Config.AzureEmailConnectionString) ||
                               !string.IsNullOrEmpty(Model.Config.SmtpHost);
            }

            @if (hasEmail)
            {
                @if (!string.IsNullOrEmpty(Model.Config.SendGridApiKey))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-primary">SendGrid</span>
                        </dd>
                        <dt class="col-sm-4">API Key:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">������������</code>
                            <span class="badge bg-success ms-2">Configured</span>
                        </dd>
                    </dl>
                }
                else if (!string.IsNullOrEmpty(Model.Config.AzureEmailConnectionString))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-primary">Azure Communication Services</span>
                        </dd>
                        <dt class="col-sm-4">Connection:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">������������</code>
                            <span class="badge bg-success ms-2">Configured</span>
                        </dd>
                    </dl>
                }
                else if (!string.IsNullOrEmpty(Model.Config.SmtpHost))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-primary">SMTP</span>
                        </dd>
                        <dt class="col-sm-4">Host:</dt>
                        <dd class="col-sm-8">@Model.Config.SmtpHost</dd>
                        <dt class="col-sm-4">Port:</dt>
                        <dd class="col-sm-8">@Model.Config.SmtpPort</dd>
                        <dt class="col-sm-4">Username:</dt>
                        <dd class="col-sm-8">@Model.Config.SmtpUsername</dd>
                    </dl>
                }
            }
            else
            {
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle"></i> Email not configured (optional)
                </p>
            }
        </div>
    </div>

    <!-- CDN Configuration -->
    <div class="card mb-3 bg-secondary text-light">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-network-wired"></i> CDN</h5>
            <a href="@Url.Page("./Step5_Cdn")" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            @{
                var hasCdn = !string.IsNullOrEmpty(Model.Config.AzureCdnSubscriptionId) ||
                             !string.IsNullOrEmpty(Model.Config.CloudflareApiToken) ||
                             !string.IsNullOrEmpty(Model.Config.SucuriApiKey);
            }

            @if (hasCdn)
            {
                @if (!string.IsNullOrEmpty(Model.Config.AzureCdnSubscriptionId))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-primary">
                                @(Model.Config.AzureCdnIsFrontDoor ? "Azure Front Door" : "Azure CDN")
                            </span>
                        </dd>
                        <dt class="col-sm-4">Subscription:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">@Model.Config.AzureCdnSubscriptionId</code>
                        </dd>
                        <dt class="col-sm-4">Resource Group:</dt>
                        <dd class="col-sm-8">@Model.Config.AzureCdnResourceGroup</dd>
                        <dt class="col-sm-4">Profile:</dt>
                        <dd class="col-sm-8">@Model.Config.AzureCdnProfileName</dd>
                        <dt class="col-sm-4">Endpoint:</dt>
                        <dd class="col-sm-8">@Model.Config.AzureCdnEndpointName</dd>
                    </dl>
                }
                else if (!string.IsNullOrEmpty(Model.Config.CloudflareApiToken))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-warning text-dark">Cloudflare</span>
                        </dd>
                        <dt class="col-sm-4">API Token:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">������������</code>
                            <span class="badge bg-success ms-2">Configured</span>
                        </dd>
                        <dt class="col-sm-4">Zone ID:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">@Model.Config.CloudflareZoneId</code>
                        </dd>
                    </dl>
                }
                else if (!string.IsNullOrEmpty(Model.Config.SucuriApiKey))
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Provider:</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-success">Sucuri WAF/CDN</span>
                        </dd>
                        <dt class="col-sm-4">API Key:</dt>
                        <dd class="col-sm-8">
                            <code class="text-muted">������������</code>
                            <span class="badge bg-success ms-2">Configured</span>
                        </dd>
                    </dl>
                }
            }
            else
            {
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle"></i> CDN not configured (optional)
                </p>
            }
        </div>
    </div>

    <!-- Confirmation -->
    <div class="card border-warning mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Important</h5>
        </div>
        <div class="card-body text-dark">
            <p>Please review all settings carefully. After completing the setup:</p>
            <ul class="mb-3">
                <li>The setup wizard will be <strong>permanently disabled</strong></li>
                <li>You must <strong>restart the application</strong> for changes to take effect</li>
                <li>The administrator account will be created with the email and password shown above</li>
                <li>All settings can be modified later through the admin panel</li>
            </ul>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="confirmSetup" required>
                <label class="form-check-label text-dark" for="confirmSetup">
                    I have reviewed all settings and understand that the setup wizard will be disabled after completion
                </label>
            </div>
        </div>
    </div>
}

<form method="post" id="reviewForm">
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
    @Html.AntiForgeryToken()

    <div class="d-flex justify-content-between mt-4">
        <a href="@Url.Page("./Step5_Cdn")" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <button type="submit" class="btn btn-success btn-lg" id="completeButton" disabled>
            <i class="fas fa-check-circle"></i> Complete Setup
        </button>
    </div>

    <input type="hidden" asp-for="SetupId" />
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#confirmSetup').change(function () {
                $('#completeButton').prop('disabled', !this.checked);
            });
        });
    </script>
}
