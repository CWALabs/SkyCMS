AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy SkyCMS Editor and Publisher on AWS using ECS Fargate, S3,
  RDS MySQL, and an Application Load Balancer (ALB) with host-based routing (TLS
  optional).

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Basic Configuration
        Parameters:
          - InstallId
          - StackName
          - AdminEmailAddress
      - Label:
          default: S3 Storage Configuration
        Parameters:
          - S3BucketName
          - S3Region
          - S3AccessKeyId
          - S3SecretAccessKey
      - Label:
          default: Email Provider - SendGrid (option 1)
        Parameters:
          - SendGridApiKey
      - Label:
          default: Email Provider - SMTP (option 2)
        Parameters:
          - SmtpHostName
          - SmtpPort
          - SmtpEnableSsl
          - SmtpUserName
          - SmtpPassword
      - Label:
          default: Email Provider - Azure Communications (option 3)
        Parameters:
          - AzureCommunicationsConnectionString
      - Label:
          default: Application Settings
        Parameters:
          - EditorImage
          - PublisherImage
          - DesiredCount
          - AssignPublicIp
      - Label:
          default: Custom Domain & TLS (optional)
        Parameters:
          - EditorHostName
          - PublisherHostName
          - ACMCertificateArn
          - RedirectHttpToHttps
      - Label:
          default: Database Configuration
        Parameters:
          - DBInstanceClass
          - DBAllocatedStorage
          - DBBackupRetentionDays
          - DBName
          - DbUsername
          - DbPassword
      - Label:
          default: Network Configuration (advanced)
        Parameters:
          - VpcCidr
          - PublicSubnet1Cidr
          - PublicSubnet2Cidr
          - PrivateSubnet1Cidr
          - PrivateSubnet2Cidr
    ParameterLabels:
      InstallId:
        default: Installation ID
      StackName:
        default: Stack Name Prefix
      AdminEmailAddress:
        default: Administrator Email
      S3BucketName:
        default: S3 Bucket Name
      S3Region:
        default: S3 Region
      S3AccessKeyId:
        default: S3 Access Key ID
      S3SecretAccessKey:
        default: S3 Secret Access Key
      SendGridApiKey:
        default: API Key (leave blank if not using SendGrid)
      AzureCommunicationsConnectionString:
        default: Connection String (leave blank if not using Azure Communications)
      SmtpHostName:
        default: Host Name (e.g., smtp.gmail.com)
      SmtpPort:
        default: Port Number (e.g., 587)
      SmtpEnableSsl:
        default: Enable SSL/TLS (true/false)
      SmtpUserName:
        default: Username
      SmtpPassword:
        default: Password
      EditorImage:
        default: Editor Container Image
      PublisherImage:
        default: Publisher Container Image
      DesiredCount:
        default: Desired Task Count
      AssignPublicIp:
        default: Assign Public IP to Tasks
      EditorHostName:
        default: Editor Host Name
      PublisherHostName:
        default: Publisher Host Name
      ACMCertificateArn:
        default: ACM Certificate ARN
      RedirectHttpToHttps:
        default: Redirect HTTP to HTTPS
      DBInstanceClass:
        default: Database Instance Class
      DBAllocatedStorage:
        default: Database Storage (GB)
      DBBackupRetentionDays:
        default: Backup Retention Days
      DBName:
        default: Database Name
      DbUsername:
        default: Database Username
      DbPassword:
        default: Database Password
      VpcCidr:
        default: VPC CIDR Block
      PublicSubnet1Cidr:
        default: Public Subnet 1 CIDR
      PublicSubnet2Cidr:
        default: Public Subnet 2 CIDR
      PrivateSubnet1Cidr:
        default: Private Subnet 1 CIDR
      PrivateSubnet2Cidr:
        default: Private Subnet 2 CIDR

Parameters:
  InstallId:
    Type: String
    Description: A short install name to tag all resources (used as value for tag
      key 'skycms-install-id')

  StackName:
    Type: String
    Default: skycms
    Description: Logical name prefix for created resources

  # Networking
  VpcCidr:
    Type: String
    Default: 10.1.0.0/16
    Description: CIDR block for the new VPC
  PublicSubnet1Cidr:
    Type: String
    Default: 10.1.0.0/24
    Description: CIDR for public subnet 1 (AZ 1)
  PublicSubnet2Cidr:
    Type: String
    Default: 10.1.1.0/24
    Description: CIDR for public subnet 2 (AZ 2)
  PrivateSubnet1Cidr:
    Type: String
    Default: 10.1.100.0/24
    Description: CIDR for private subnet 1 (AZ 1)
  PrivateSubnet2Cidr:
    Type: String
    Default: 10.1.101.0/24
    Description: CIDR for private subnet 2 (AZ 2)

  # S3
  S3BucketName:
    Type: String
    Description: S3 bucket name for blob storage (must be globally unique). WARNING - The bucket will be created by this template. Ensure the name does not already exist.
  S3Region:
    Type: String
    Default: us-west-2
    Description: AWS region of the S3 bucket
  S3AccessKeyId:
    Type: String
    NoEcho: true
    Description: S3 access key ID used by the apps to access the bucket
  S3SecretAccessKey:
    Type: String
    NoEcho: true
    Description: S3 secret access key used by the apps to access the bucket

  # App settings
  AdminEmailAddress:
    Type: String
    Description: Administrator email for initial account and notifications

  # Email provider settings (choose one)
  SendGridApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: Optional SendGrid API key for email notifications. Leave blank if
      using SMTP or Azure Communications.
  AzureCommunicationsConnectionString:
    Type: String
    NoEcho: true
    Default: ''
    Description: Optional Azure Communications connection string for email
      notifications. Leave blank if using SendGrid or SMTP.
  SmtpHostName:
    Type: String
    Default: ''
    Description: Optional SMTP host name for email notifications (e.g.,
      smtp.mycompany.com). Leave blank if using SendGrid or Azure
      Communications.
  SmtpPort:
    Type: String
    Default: ''
    Description: Optional SMTP port number (e.g., 587). Required if SmtpHostName is
      specified.
  SmtpEnableSsl:
    Type: String
    AllowedValues:
      - ''
      - 'true'
      - 'false'
    Default: ''
    Description: Optional SMTP SSL/TLS setting. Set to 'true' or 'false' if using SMTP.
  SmtpUserName:
    Type: String
    Default: ''
    Description: Optional SMTP username. Required if SmtpHostName is specified.
  SmtpPassword:
    Type: String
    NoEcho: true
    Default: ''
    Description: Optional SMTP password. Required if SmtpHostName is specified.

  DesiredCount:
    Type: Number
    Default: '1'
    Description: Desired number of ECS tasks for each service
  EditorImage:
    Type: String
    Default: toiyabe/sky-editor:latest
    Description: Container image for the Editor service
  PublisherImage:
    Type: String
    Default: toiyabe/sky-publisher:latest
    Description: Container image for the Publisher service
  AssignPublicIp:
    Type: String
    AllowedValues:
      - ENABLED
      - DISABLED
    Default: ENABLED
    Description: Whether to assign a public IP to ECS tasks (enable to allow Docker
      Hub pulls in public subnets)

  # Hostnames and TLS
  EditorHostName:
    Type: String
    Default: ''
    Description: Optional fully qualified host name for the Editor (e.g., editor.example.com). Leave blank to use CloudFront domain only.
  PublisherHostName:
    Type: String
    Default: ''
    Description: Optional fully qualified host name for the Publisher (e.g., www.example.com). Leave blank to use CloudFront domain only.
  RedirectHttpToHttps:
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: If true and HTTPS is configured, HTTP (80) requests will be
      redirected to HTTPS (443) with 301.
  ACMCertificateArn:
    Type: String
    Default: ''
    Description: Optional ACM certificate ARN for HTTPS (443) on the load balancer.
      Leave blank to skip HTTPS.

  # Database
  DBInstanceClass:
    Type: String
    Default: db.t3.micro
    Description: RDS instance class
  DBAllocatedStorage:
    Type: String
    Default: '20'
    Description: RDS storage (GB)
  DBBackupRetentionDays:
    Type: Number
    Default: '7'
    Description: Backup retention days (minimum 7 recommended for production)
  DBName:
    Type: String
    Default: skycms
    Description: MySQL database name
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: ^[A-Za-z0-9_]+$
    ConstraintDescription: Letters, numbers, underscore; 1-64 chars.

  # Database credentials (no Secrets Manager)
  DbUsername:
    Type: String
    Default: skycmsadmin
    Description: MySQL admin username
    MinLength: '1'
    MaxLength: '32'
    AllowedPattern: ^[A-Za-z0-9_]+$
    ConstraintDescription: Letters, numbers, underscore; 1-32 chars.
  DbPassword:
    Type: String
    NoEcho: true
    Description: MySQL admin password (will be set on the RDS instance and injected
      into container env vars)
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: ^[^\s/@"]+$
    ConstraintDescription: 8-41 printable ASCII; cannot contain space, /, @, or " characters.

Mappings: {}

Conditions:
  UseHTTPS: !Not
    - !Equals
      - !Ref ACMCertificateArn
      - ''
  UsePublisherHostName: !Not
    - !Equals
      - !Ref PublisherHostName
      - ''
  RedirectToHTTPS: !And
    - !Not
      - !Equals
        - !Ref ACMCertificateArn
        - ''
    - !Equals
      - !Ref RedirectHttpToHttps
      - 'true'
  CreateHttpRules: !Or
    - !Equals
      - !Ref ACMCertificateArn
      - ''
    - !Not
      - !Equals
        - !Ref RedirectHttpToHttps
        - 'true'
  UseHTTPSAndPublisher: !And
    - !Not
      - !Equals
        - !Ref ACMCertificateArn
        - ''
    - !Not
      - !Equals
        - !Ref PublisherHostName
        - ''
  CreateHttpRulesAndPublisher: !And
    - !Or
      - !Equals
        - !Ref ACMCertificateArn
        - ''
      - !Not
        - !Equals
          - !Ref RedirectHttpToHttps
          - 'true'
    - !Not
      - !Equals
        - !Ref PublisherHostName
        - ''

Resources:
  # VPC and networking
  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref S3BucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # VPC and networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-vpc
        - Key: skycms-install-id
          Value: !Ref InstallId

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-igw
        - Key: skycms-install-id
          Value: !Ref InstallId

  IGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-public-rt
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: IGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-private-rt-a
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-private-rt-b
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-public-a
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-public-b
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1Cidr
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-private-a
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2Cidr
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${StackName}-private-b
        - Key: skycms-install-id
          Value: !Ref InstallId

  PubSubnet1RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PubSubnet2RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivSubnet1RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivSubnet2RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # Security groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for public ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ALB to reach Editor ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet1Cidr
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet2Cidr
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ALB to reach Publisher ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet1Cidr
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet2Cidr
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL from ECS services
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EditorServiceSG
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PublisherServiceSG
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # S3 Bucket for ALB Access Logs
  ALBLogsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub ${StackName}-alb-logs-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 30
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  ALBLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ALBLogsBucket
      PolicyDocument:
        Statement:
          - Sid: AWSLogDeliveryWrite
            Effect: Allow
            Principal:
              Service: elasticloadbalancing.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub ${ALBLogsBucket.Arn}/*

  # ALB
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn: ALBLogsBucketPolicy
    Properties:
      Name: !Sub ${StackName}-alb
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      LoadBalancerAttributes:
        - Key: access_logs.s3.enabled
          Value: 'true'
        - Key: access_logs.s3.bucket
          Value: !Ref ALBLogsBucket
        - Key: idle_timeout.timeout_seconds
          Value: '60'
        - Key: deletion_protection.enabled
          Value: 'false'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${StackName}-pub-tg
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200-399
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${StackName}-ed-tg
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200-399
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpsListener:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  # Header-based rules for CloudFront routing (x-sky-app header)
  HttpEditorHeaderRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 5
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: x-sky-app
            Values:
              - editor
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpPublisherHeaderRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 6
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: x-sky-app
            Values:
              - publisher
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  # Host-based rules for custom domains (when provided)
  HttpEditorHostRule:
    Condition: CreateHttpRules
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref EditorHostName
      Actions:
        - !If
          - RedirectToHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              Host: '#{host}'
              Path: '/#{path}'
              Query: '#{query}'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref EditorTargetGroup

  HttpPublisherHostRule:
    Condition: CreateHttpRulesAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 11
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref PublisherHostName
      Actions:
        - !If
          - RedirectToHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              Host: '#{host}'
              Path: '/#{path}'
              Query: '#{query}'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref PublisherTargetGroup

  # HTTPS header-based rules
  HttpsEditorHeaderRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 5
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: x-sky-app
            Values:
              - editor
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpsPublisherHeaderRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 6
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: x-sky-app
            Values:
              - publisher
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  # HTTPS host-based rules for custom domains
  HttpsEditorHostRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref EditorHostName
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpsPublisherHostRule:
    Condition: UseHTTPSAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 11
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref PublisherHostName
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  # Logs
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/ecs/${StackName}
      RetentionInDays: 14
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # RDS MySQL (in private subnets)
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: SkyCMS DB subnet group
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  MySqlDB:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub ${StackName}-mysql
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceClass
      Engine: mysql
      EngineVersion: '8.0'
      MultiAZ: false
      StorageType: gp3
      StorageEncrypted: true
      PubliclyAccessible: false
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBName: !Ref DBName
      MasterUsername: !Ref DbUsername
      MasterUserPassword: !Ref DbPassword
      BackupRetentionPeriod: !Ref DBBackupRetentionDays
      PreferredBackupWindow: 03:00-04:00
      PreferredMaintenanceWindow: sun:04:00-sun:05:00
      EnableCloudwatchLogsExports:
        - error
        - general
        - slowquery
      DeletionProtection: false

  # ECS
  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${StackName}-cluster
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: s3-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${S3BucketName}
                  - !Sub arn:aws:s3:::${S3BucketName}/*
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${StackName}-editor
      Cpu: '512'
      Memory: '1024'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - Name: editor
          Image: !Ref EditorImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosAllowSetup
              Value: 'true'
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: http://+:8080
            - Name: CosmosPublisherUrl
              Value: !Sub 'https://${PublisherDistribution.DomainName}'
            - Name: AzureBlobStorageEndPoint
              Value: /
            - Name: CosmosSendGridApiKey
              Value: !Ref SendGridApiKey
            - Name: SmtpEmailProviderOptions__Host
              Value: !Ref SmtpHostName
            - Name: SmtpEmailProviderOptions__Port
              Value: !Ref SmtpPort
            - Name: SmtpEmailProviderOptions__EnableSsl
              Value: !Ref SmtpEnableSsl
            - Name: SmtpEmailProviderOptions__UserName
              Value: !Ref SmtpUserName
            - Name: SmtpEmailProviderOptions__Password
              Value: !Ref SmtpPassword
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Join
                - ''
                - - Server=
                  - !GetAtt MySqlDB.Endpoint.Address
                  - ;uid=
                  - !Ref DbUsername
                  - ;pwd=
                  - !Ref DbPassword
                  - ;database=
                  - !Ref DBName
                  - ;
            - Name: ConnectionStrings__AzureCommunicationConnection
              Value: !Ref AzureCommunicationsConnectionString
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: editor
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${StackName}-publisher
      Cpu: '512'
      Memory: '1024'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - Name: publisher
          Image: !Ref PublisherImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: http://+:8080
            - Name: AzureBlobStorageEndPoint
              Value: /
            - Name: CosmosSendGridApiKey
              Value: !Ref SendGridApiKey
            - Name: SmtpEmailProviderOptions__Host
              Value: !Ref SmtpHostName
            - Name: SmtpEmailProviderOptions__Port
              Value: !Ref SmtpPort
            - Name: SmtpEmailProviderOptions__EnableSsl
              Value: !Ref SmtpEnableSsl
            - Name: SmtpEmailProviderOptions__UserName
              Value: !Ref SmtpUserName
            - Name: SmtpEmailProviderOptions__Password
              Value: !Ref SmtpPassword
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Join
                - ''
                - - Server=
                  - !GetAtt MySqlDB.Endpoint.Address
                  - ;uid=
                  - !Ref DbUsername
                  - ;pwd=
                  - !Ref DbPassword
                  - ;database=
                  - !Ref DBName
                  - ;
            - Name: ConnectionStrings__AzureCommunicationConnection
              Value: !Ref AzureCommunicationsConnectionString
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: publisher
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # Services
  EditorService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets:
            - !Ref PublicSubnet1
            - !Ref PublicSubnet2
          SecurityGroups:
            - !Ref EditorServiceSG
      TaskDefinition: !Ref EditorTaskDefinition
      LoadBalancers:
        - ContainerName: editor
          ContainerPort: 8080
          TargetGroupArn: !Ref EditorTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets:
            - !Ref PublicSubnet1
            - !Ref PublicSubnet2
          SecurityGroups:
            - !Ref PublisherServiceSG
      TaskDefinition: !Ref PublisherTaskDefinition
      LoadBalancers:
        - ContainerName: publisher
          ContainerPort: 8080
          TargetGroupArn: !Ref PublisherTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # CloudFront distributions to provide automatic TLS-enabled domains without DNS setup
  EditorDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub ${StackName}-editor
        HttpVersion: http2and3
        DefaultRootObject: ''
        Origins:
          - Id: alb-origin-editor
            DomainName: !GetAtt ApplicationLoadBalancer.DNSName
            CustomOriginConfig:
              OriginProtocolPolicy: http-only
              HTTPPort: 80
              HTTPSPort: 443
              OriginSSLProtocols:
                - TLSv1.2
              OriginReadTimeout: 60
              OriginKeepaliveTimeout: 5
            OriginCustomHeaders:
              - HeaderName: x-sky-app
                HeaderValue: editor
        DefaultCacheBehavior:
          TargetOriginId: alb-origin-editor
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - POST
            - PATCH
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingDisabled managed policy
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3  # AllViewer managed policy
          Compress: true
        PriceClass: PriceClass_All
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  PublisherDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub ${StackName}-publisher
        HttpVersion: http2and3
        DefaultRootObject: ''
        Origins:
          - Id: alb-origin-publisher
            DomainName: !GetAtt ApplicationLoadBalancer.DNSName
            CustomOriginConfig:
              OriginProtocolPolicy: http-only
              HTTPPort: 80
              HTTPSPort: 443
              OriginSSLProtocols:
                - TLSv1.2
              OriginReadTimeout: 60
              OriginKeepaliveTimeout: 5
            OriginCustomHeaders:
              - HeaderName: x-sky-app
                HeaderValue: publisher
        DefaultCacheBehavior:
          TargetOriginId: alb-origin-publisher
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - POST
            - PATCH
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized managed policy
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3  # AllViewer managed policy
          Compress: true
        PriceClass: PriceClass_All
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
  LoadBalancerDNSName:
    Description: Public DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
  EditorCloudFrontDomain:
    Description: Public DNS name for the Editor via CloudFront (TLS-enabled)
    Value: !GetAtt EditorDistribution.DomainName
  PublisherCloudFrontDomain:
    Description: Public DNS name for the Publisher via CloudFront (TLS-enabled)
    Value: !GetAtt PublisherDistribution.DomainName
  EditorServiceName:
    Description: ECS service name for Editor
    Value: !Ref EditorService
  PublisherServiceName:
    Description: ECS service name for Publisher
    Value: !Ref PublisherService
  DbEndpoint:
    Description: RDS MySQL endpoint
    Value: !GetAtt MySqlDB.Endpoint.Address
  S3Bucket:
    Description: S3 bucket used for blob storage
    Value: !Ref S3BucketName