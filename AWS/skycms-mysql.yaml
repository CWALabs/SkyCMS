AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy SkyCMS Editor and Publisher on AWS using ECS Fargate, S3, RDS MySQL, and an Application Load Balancer (ALB) with host-based routing (TLS optional).

Parameters:
  InstallId:
    Type: String
    Description: A short install name to tag all resources (used as value for tag key 'skycms-install-id')

  StackName:
    Type: String
    Default: skycms
    Description: Logical name prefix for created resources

  # Networking
  VpcCidr:
    Type: String
    Default: '10.1.0.0/16'
    Description: CIDR block for the new VPC
  PublicSubnet1Cidr:
    Type: String
    Default: '10.1.0.0/24'
    Description: CIDR for public subnet 1 (AZ 1)
  PublicSubnet2Cidr:
    Type: String
    Default: '10.1.1.0/24'
    Description: CIDR for public subnet 2 (AZ 2)
  PrivateSubnet1Cidr:
    Type: String
    Default: '10.1.100.0/24'
    Description: CIDR for private subnet 1 (AZ 1)
  PrivateSubnet2Cidr:
    Type: String
    Default: '10.1.101.0/24'
    Description: CIDR for private subnet 2 (AZ 2)

  # S3
  S3BucketName:
    Type: String
    Description: S3 bucket name for blob storage (must be globally unique)
  S3Region:
    Type: String
    Default: us-west-2
    Description: AWS region of the S3 bucket
  S3AccessKeyId:
    Type: String
    NoEcho: true
    Description: S3 access key ID used by the apps to access the bucket
  S3SecretAccessKey:
    Type: String
    NoEcho: true
    Description: S3 secret access key used by the apps to access the bucket

  # App settings
  AdminEmailAddress:
    Type: String
    Description: Administrator email for initial account and notifications
  DesiredCount:
    Type: Number
    Default: '1'
    Description: Desired number of ECS tasks for each service
  EditorImage:
    Type: String
    Default: toiyabe/sky-editor:latest
    Description: Container image for the Editor service
  PublisherImage:
    Type: String
    Default: toiyabe/sky-publisher:latest
    Description: Container image for the Publisher service
  AssignPublicIp:
    Type: String
    AllowedValues: [ ENABLED, DISABLED ]
    Default: ENABLED
    Description: Whether to assign a public IP to ECS tasks (enable to allow Docker Hub pulls in public subnets)

  # Hostnames and TLS
  EditorHostName:
    Type: String
    Description: Fully qualified host name for the Editor (e.g., editor.example.com)
  PublisherHostName:
    Type: String
    Default: ''
    Description: Optional fully qualified host name for the Publisher (e.g., www.example.com). If blank, default action serves Publisher.
  RedirectHttpToHttps:
    Type: String
    AllowedValues: ['true','false']
    Default: 'false'
    Description: If true and HTTPS is configured, HTTP (80) requests will be redirected to HTTPS (443) with 301.
  ACMCertificateArn:
    Type: String
    Default: ''
    Description: Optional ACM certificate ARN for HTTPS (443) on the load balancer. Leave blank to skip HTTPS.

  # Database
  DBInstanceClass:
    Type: String
    Default: db.t3.micro
    Description: RDS instance class
  DBAllocatedStorage:
    Type: String
    Default: '20'
    Description: RDS storage (GB)
  DBBackupRetentionDays:
    Type: Number
    Default: '3'
    Description: Backup retention days

  # Database credentials (no Secrets Manager)
  DbUsername:
    Type: String
    Default: skycmsadmin
    Description: MySQL admin username
    MinLength: 1
    MaxLength: 32
    AllowedPattern: '^[A-Za-z0-9_]+$'
    ConstraintDescription: 'Letters, numbers, underscore; 1-32 chars.'
  DbPassword:
    Type: String
    NoEcho: true
    Description: MySQL admin password (will be set on the RDS instance and injected into container env vars)
    MinLength: 8
    MaxLength: 41
    AllowedPattern: '^[^\s/@"]+$'
    ConstraintDescription: '8-41 printable ASCII; cannot contain space, /, @, or " characters.'

Mappings: {}

Conditions:
  UseHTTPS: !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ]
  UsePublisherHostName: !Not [ !Equals [ !Ref PublisherHostName, '' ] ]
  RedirectToHTTPS: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Equals [ !Ref RedirectHttpToHttps, 'true' ] ]
  CreateHttpRules: !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ]
  UseHTTPSAndPublisher: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]
  CreateHttpRulesAndPublisher: !And [ !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]

Resources:
  # VPC and networking
  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref S3BucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # VPC and networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-vpc"
        - Key: skycms-install-id
          Value: !Ref InstallId

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-igw"
        - Key: skycms-install-id
          Value: !Ref InstallId

  IGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-rt"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: IGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-rt-a"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-rt-b"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-a"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-b"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1Cidr
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-a"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2Cidr
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-b"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PubSubnet1RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PubSubnet2RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivSubnet1RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivSubnet2RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # Security groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for public ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
        - !If
          - UseHTTPS
          - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: '0.0.0.0/0' }
          - { Ref: AWS::NoValue }
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ALB to reach Editor ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet1Cidr
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet2Cidr
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ALB to reach Publisher ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet1Cidr
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref PrivateSubnet2Cidr
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL from ECS services
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EditorServiceSG
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PublisherServiceSG
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # ALB
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${StackName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
      SecurityGroups: [ !Ref ALBSecurityGroup ]
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-pub-tg"
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-ed-tg"
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - !If
          - RedirectToHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref PublisherTargetGroup

  HttpsListener:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpEditorRule:
    Condition: CreateHttpRules
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpPublisherRule:
    Condition: CreateHttpRulesAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpsEditorRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpsPublisherRule:
    Condition: UseHTTPSAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  # Logs
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ecs/${StackName}"
      RetentionInDays: 14
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId


  # RDS MySQL (in private subnets)
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: SkyCMS DB subnet group
      SubnetIds: [ !Ref PrivateSubnet1, !Ref PrivateSubnet2 ]
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  MySqlDB:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub "${StackName}-mysql"
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceClass
      Engine: mysql
      EngineVersion: '8.0'
      MultiAZ: false
      StorageType: gp3
      PubliclyAccessible: false
      VPCSecurityGroups: [ !Ref DBSecurityGroup ]
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBName: skycms
      MasterUsername: !Ref DbUsername
      MasterUserPassword: !Ref DbPassword
      BackupRetentionPeriod: !Ref DBBackupRetentionDays
      DeleteAutomatedBackups: true
      EnableIAMDatabaseAuthentication: false
      AutoMinorVersionUpgrade: true

  # ECS
  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${StackName}-cluster"
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: s3-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3BucketName}"
                  - !Sub "arn:aws:s3:::${S3BucketName}/*"
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-editor"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - Name: editor
          Image: !Ref EditorImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosAllowSetup
              Value: 'true'
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:8080'
            - Name: CosmosPublisherUrl
              Value: !If
                - UsePublisherHostName
                - !If
                  - UseHTTPS
                  - !Sub "https://${PublisherHostName}"
                  - !Sub "http://${PublisherHostName}"
                - ''
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Join
                - ''
                - - 'Server='
                  - !GetAtt MySqlDB.Endpoint.Address
                  - ';Port=3306;Database=skycms;User Id='
                  - !Ref DbUsername
                  - ';Password='
                  - !Ref DbPassword
                  - ';'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: editor
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-publisher"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - Name: publisher
          Image: !Ref PublisherImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:8080'
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Join
                - ''
                - - 'Server='
                  - !GetAtt MySqlDB.Endpoint.Address
                  - ';Port=3306;Database=skycms;User Id='
                  - !Ref DbUsername
                  - ';Password='
                  - !Ref DbPassword
                  - ';'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: publisher
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  # Services
  EditorService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
          SecurityGroups: [ !Ref EditorServiceSG ]
      TaskDefinition: !Ref EditorTaskDefinition
      LoadBalancers:
        - ContainerName: editor
          ContainerPort: 8080
          TargetGroupArn: !Ref EditorTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
          SecurityGroups: [ !Ref PublisherServiceSG ]
      TaskDefinition: !Ref PublisherTaskDefinition
      LoadBalancers:
        - ContainerName: publisher
          ContainerPort: 8080
          TargetGroupArn: !Ref PublisherTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
  LoadBalancerDNSName:
    Description: Public DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
  EditorServiceName:
    Description: ECS service name for Editor
    Value: !Ref EditorService
  PublisherServiceName:
    Description: ECS service name for Publisher
    Value: !Ref PublisherService
  DbEndpoint:
    Description: RDS MySQL endpoint
    Value: !GetAtt MySqlDB.Endpoint.Address
  S3Bucket:
    Description: S3 bucket used for blob storage
    Value: !Ref S3BucketName
