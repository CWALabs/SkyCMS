AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy SkyCMS Editor and Publisher on AWS using ECS Fargate, S3 (blob storage), EFS (SQLite persistence), and an Application Load Balancer (host-based routing)

Parameters:
  CreateNewVPC:
    Type: String
    AllowedValues: ['true','false']
    Default: 'true'
    Description: When 'true', this template will create a new VPC with two public subnets and use it. When 'false', provide VpcId and PublicSubnets.

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the new VPC (used only when CreateNewVPC=true)

  PublicSubnet1Cidr:
    Type: String
    Default: 10.0.0.0/24
    Description: CIDR for public subnet 1 (AZ 1) when creating a new VPC

  PublicSubnet2Cidr:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR for public subnet 2 (AZ 2) when creating a new VPC
  CreatePrivateSubnets:
    Type: String
    AllowedValues: ['true','false']
    Default: 'true'
    Description: When 'true' and CreateNewVPC=true, create two private subnets with a NAT Gateway for egress (good for databases later)
  StackName:
    Type: String
    Default: skycms
    Description: Logical name prefix for created resources

  VpcId:
    Type: String
    Default: ''
    Description: Existing VPC ID to deploy into (used only when CreateNewVPC=false). Leave blank when creating a new VPC.

  PublicSubnets:
    Type: CommaDelimitedList
    Default: ','
    Description: Comma-delimited list of two public subnet IDs (used only when CreateNewVPC=false). Leave blank when creating a new VPC.

  S3BucketName:
    Type: String
    Description: S3 bucket name for blob storage

  S3Region:
    Type: String
    Description: AWS region of the S3 bucket (commercial AWS regions)
    AllowedValues:
      # Americas
      - us-east-1      # N. Virginia
      - us-east-2      # Ohio
      - us-west-1      # N. California
      - us-west-2      # Oregon
      - ca-central-1   # Canada (Central)
      - ca-west-1      # Canada West (Calgary)
      - sa-east-1      # South America (Sao Paulo)

      # Europe
      - eu-west-1      # Ireland
      - eu-west-2      # London
      - eu-west-3      # Paris
      - eu-central-1   # Frankfurt
      - eu-central-2   # Zurich
      - eu-north-1     # Stockholm
      - eu-south-1     # Milan
      - eu-south-2     # Spain

      # Asia Pacific
      - ap-south-1     # Mumbai
      - ap-south-2     # Hyderabad
      - ap-southeast-1 # Singapore
      - ap-southeast-2 # Sydney
      - ap-southeast-3 # Jakarta
      - ap-southeast-4 # Melbourne
      - ap-southeast-5 # Malaysia (Kuala Lumpur)
      - ap-northeast-1 # Tokyo
      - ap-northeast-2 # Seoul
      - ap-northeast-3 # Osaka
      - ap-east-1      # Hong Kong

      # Middle East & Africa
      - me-south-1     # Bahrain
      - me-central-1   # UAE (Dubai)
      - me-west-1      # Israel (Tel Aviv)
      - af-south-1     # Cape Town
    Default: us-west-2

  S3AccessKeyId:
    Type: String
    NoEcho: true
    Description: S3 access key ID used by the app to access the bucket

  S3SecretAccessKey:
    Type: String
    NoEcho: true
    Description: S3 secret access key used by the app to access the bucket

  AdminEmailAddress:
    Type: String
    Description: Administrator email for initial account and notifications

  SmtpHostName:
    Type: String
    Default: ''
    Description: SMTP relay host (optional)

  SmtpPort:
    Type: Number
    Default: 587
    Description: SMTP port (optional)

  SmtpEnableTls:
    Type: String
    AllowedValues: ['true','false']
    Default: 'true'
    Description: Enable TLS for SMTP (optional)

  SmtpUserName:
    Type: String
    Default: ''
    Description: SMTP username (optional)

  SmtpPassword:
    Type: String
    NoEcho: true
    Default: ''
    Description: SMTP password (optional)

  SendGridApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: SendGrid API key (optional)

  DesiredCount:
    Type: Number
    Default: 1
    Description: Desired number of ECS tasks for each service

  EditorImage:
    Type: String
    Default: toiyabe/sky-editor:latest
    Description: Container image for the Editor service

  PublisherImage:
    Type: String
    Default: toiyabe/sky-publisher:latest
    Description: Container image for the Publisher service

  PublisherPublicUrl:
    Type: String
    Default: ''
    Description: Optional public URL for the Publisher site (used by the Editor); provide if no load balancer is used

  ACMCertificateArn:
    Type: String
    Default: ''
    Description: Optional ACM certificate ARN for HTTPS (443) on the load balancer. Leave blank to skip HTTPS.

  EditorHostName:
    Type: String
    Description: Fully qualified host name for the Editor (e.g., editor.example.com)

  PublisherHostName:
    Type: String
    Default: ''
    Description: Optional fully qualified host name for the Publisher (e.g., www.example.com). If blank, default action serves Publisher.

  RedirectHttpToHttps:
    Type: String
    AllowedValues: ['true','false']
    Default: 'false'
    Description: If true and HTTPS is configured, HTTP (80) requests will be redirected to HTTPS (443) with 301.

  HostedZoneId:
    Type: String
    Default: ''
    Description: Optional Route 53 Hosted Zone ID to create DNS A-records for Editor/Publisher hostnames pointing to the ALB.

  AssignPublicIp:
    Type: String
    AllowedValues: [ ENABLED, DISABLED ]
    Default: ENABLED
    Description: Whether to assign a public IP to ECS tasks. Enable if your subnets do not have NAT internet egress.


Mappings: {}

Conditions:
  CreateNewVPCCond: !Equals [ !Ref CreateNewVPC, 'true' ]
  PrivateEnabled: !And [ !Equals [ !Ref CreateNewVPC, 'true' ], !Equals [ !Ref CreatePrivateSubnets, 'true' ] ]
  UseSMTP: !Not [ !Equals [ !Ref SmtpHostName, '' ] ]
  UseSendGrid: !Not [ !Equals [ !Ref SendGridApiKey, '' ] ]
  UseHTTPS: !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ]
  UsePublisherHostName: !Not [ !Equals [ !Ref PublisherHostName, '' ] ]
  RedirectToHTTPS: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Equals [ !Ref RedirectHttpToHttps, 'true' ] ]
  CreateDNSRecords: !Not [ !Equals [ !Ref HostedZoneId, '' ] ]
  CreatePublisherDNS: !And [ !Not [ !Equals [ !Ref HostedZoneId, '' ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]
  CreateHttpRules: !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ]
  UseHTTPSAndPublisher: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]
  CreateHttpRulesAndPublisher: !And [ !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]

Rules:
  RequireExistingVpcParams:
    RuleCondition: !Equals [ !Ref CreateNewVPC, 'false' ]
    Assertions:
      - Assert: !Not [ !Equals [ !Ref VpcId, '' ] ]
        AssertDescription: Provide VpcId when CreateNewVPC is false.
      - Assert: !Not [ !Equals [ !Select [ 0, !Ref PublicSubnets ], '' ] ]
        AssertDescription: Provide at least two subnet IDs in PublicSubnets (first is empty).
      - Assert: !Not [ !Equals [ !Select [ 1, !Ref PublicSubnets ], '' ] ]
        AssertDescription: Provide at least two subnet IDs in PublicSubnets (second is empty).

Resources:
  # Optional new VPC with two public subnets and IGW for internet egress
  VPC:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-vpc"

  InternetGateway:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-igw"

  IGWAttachment:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]

  PublicRouteTable:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-rt"

  PublicDefaultRoute:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::Route
    DependsOn: IGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-a"

  PublicSubnet2:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-b"

  PubSubnet1RouteAssoc:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PubSubnet2RouteAssoc:
    Condition: CreateNewVPCCond
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Private subnets and NAT for future database and private workloads
  NatEip:
    Condition: PrivateEnabled
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-nat-eip"

  NatGateway:
    Condition: PrivateEnabled
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId: !Ref PublicSubnet1
      AllocationId: !GetAtt NatEip.AllocationId
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-nat"

  PrivateRouteTable:
    Condition: PrivateEnabled
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-rt"

  PrivateDefaultRoute:
    Condition: PrivateEnabled
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1:
    Condition: PrivateEnabled
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      CidrBlock: 10.0.100.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-a"

  PrivateSubnet2:
    Condition: PrivateEnabled
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      CidrBlock: 10.0.101.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-b"

  PrivSubnet1RouteAssoc:
    Condition: PrivateEnabled
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivSubnet2RouteAssoc:
    Condition: PrivateEnabled
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for public ALB
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - !If 
          - UseHTTPS
          - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: 0.0.0.0/0 }
          - { Ref: AWS::NoValue }

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${StackName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: !If [ CreateNewVPCCond, [ !Ref PublicSubnet1, !Ref PublicSubnet2 ], !Ref PublicSubnets ]
      SecurityGroups: [ !Ref ALBSecurityGroup ]

  PublisherTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-pub-tg"
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'

  EditorTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-ed-tg"
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - !If
          - RedirectToHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref PublisherTargetGroup

  HttpsListener:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpEditorRule:
    Condition: CreateHttpRules
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpPublisherRule:
    Condition: CreateHttpRulesAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpsEditorRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup
  HttpsPublisherRule:
    Condition: UseHTTPSAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup
  SqliteConnectionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${StackName}/sqlite/connection"
      Description: SkyCMS SQLite connection string with generated password
      GenerateSecretString:
        SecretStringTemplate: '{"Data Source":"/data/sqlite/skycms.db"}'
        GenerateStringKey: Password
        PasswordLength: 24
        ExcludeCharacters: '"'  # avoid breaking JSON

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ecs/${StackName}"
      RetentionInDays: 14

  EfsFileSystem:
    Type: AWS::EFS::FileSystem
    DeletionPolicy: Retain
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: !Sub "${StackName}-sqlite"

  EfsAccessPoint:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: "1000"
        Gid: "1000"
      RootDirectory:
        Path: "/data/sqlite"
        CreationInfo:
          OwnerUid: "1000"
          OwnerGid: "1000"
          Permissions: "0777"

  EfsMountSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow NFS for EFS mounts
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref EditorServiceSG
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref PublisherServiceSG

  EfsMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If [ CreateNewVPCCond, !Ref PublicSubnet1, !Select [ 0, !Ref PublicSubnets ] ]
      SecurityGroups: [ !Ref EfsMountSecurityGroup ]

  EfsMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If [ CreateNewVPCCond, !Ref PublicSubnet2, !Select [ 1, !Ref PublicSubnets ] ]
      SecurityGroups: [ !Ref EfsMountSecurityGroup ]

  EditorToEfsNfsEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref EditorServiceSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      DestinationSecurityGroupId: !Ref EfsMountSecurityGroup

  PublisherToEfsNfsEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref PublisherServiceSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      DestinationSecurityGroupId: !Ref EfsMountSecurityGroup

  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${StackName}-cluster"

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: s3-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3BucketName}"
                  - !Sub "arn:aws:s3:::${S3BucketName}/*"
        - PolicyName: efs-client
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                Resource:
                  - !Sub "arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:file-system/${EfsFileSystem}"
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                Resource:
                  - !Sub "arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:access-point/${EfsAccessPoint}"

  EditorTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-editor"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      Volumes:
        - Name: sqlite
          EFSVolumeConfiguration:
            FilesystemId: !Ref EfsFileSystem
            TransitEncryption: ENABLED
            AuthorizationConfig:
              AccessPointId: !Ref EfsAccessPoint
              IAM: ENABLED
            RootDirectory: '/'
      ContainerDefinitions:
        - Name: editor
          Image: !Ref EditorImage
          Essential: true
          PortMappings:
            - ContainerPort: 80
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosAllowSetup
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:80'
            - Name: CosmosPublisherUrl
              Value: !Ref PublisherPublicUrl
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: CosmosSendGridApiKey
              Value: !If [ UseSendGrid, !Ref SendGridApiKey, '' ]
            - Name: SmtpEmailProviderOptions__Host
              Value: !If [ UseSMTP, !Ref SmtpHostName, '' ]
            - Name: SmtpEmailProviderOptions__Port
              Value: !If [ UseSMTP, !Sub "${SmtpPort}", '587' ]
            - Name: SmtpEmailProviderOptions__EnableSsl
              Value: !If [ UseSMTP, !Ref SmtpEnableTls, 'true' ]
            - Name: SmtpEmailProviderOptions__UserName
              Value: !If [ UseSMTP, !Ref SmtpUserName, '' ]
            - Name: SmtpEmailProviderOptions__Password
              Value: !If [ UseSMTP, !Ref SmtpPassword, '' ]
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Sub 'Data Source=/data/sqlite/skycms.db;Password={{resolve:secretsmanager:${SqliteConnectionSecret}:SecretString:Password}};'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: editor
          MountPoints:
            - ContainerPath: /data/sqlite
              SourceVolume: sqlite
          LinuxParameters:
            InitProcessEnabled: true

  PublisherTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-publisher"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      Volumes:
        - Name: sqlite
          EFSVolumeConfiguration:
            FilesystemId: !Ref EfsFileSystem
            TransitEncryption: ENABLED
            AuthorizationConfig:
              AccessPointId: !Ref EfsAccessPoint
              IAM: ENABLED
            RootDirectory: '/'
      ContainerDefinitions:
        - Name: publisher
          Image: !Ref PublisherImage
          Essential: true
          PortMappings:
            - ContainerPort: 80
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:80'
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: CosmosSendGridApiKey
              Value: !If [ UseSendGrid, !Ref SendGridApiKey, '' ]
            - Name: SmtpEmailProviderOptions__Host
              Value: !If [ UseSMTP, !Ref SmtpHostName, '' ]
            - Name: SmtpEmailProviderOptions__Port
              Value: !If [ UseSMTP, !Sub "${SmtpPort}", '587' ]
            - Name: SmtpEmailProviderOptions__EnableSsl
              Value: !If [ UseSMTP, !Ref SmtpEnableTls, 'true' ]
            - Name: SmtpEmailProviderOptions__UserName
              Value: !If [ UseSMTP, !Ref SmtpUserName, '' ]
            - Name: SmtpEmailProviderOptions__Password
              Value: !If [ UseSMTP, !Ref SmtpPassword, '' ]
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Sub 'Data Source=/data/sqlite/skycms.db;Password={{resolve:secretsmanager:${SqliteConnectionSecret}:SecretString:Password}};'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: publisher
          MountPoints:
            - ContainerPath: /data/sqlite
              SourceVolume: sqlite
          LinuxParameters:
            InitProcessEnabled: true

  EditorServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP to Editor ECS service
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0

  PublisherServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP to Publisher ECS service
      VpcId: !If [ CreateNewVPCCond, !Ref VPC, !Ref VpcId ]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0

  EditorService:
    Type: AWS::ECS::Service
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: !If
            - CreateNewVPCCond
            - [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
            - [ !Select [ 0, !Ref PublicSubnets ], !Select [ 1, !Ref PublicSubnets ] ]
          SecurityGroups: [ !Ref EditorServiceSG ]
      TaskDefinition: !Ref EditorTaskDefinition
      LoadBalancers:
        - ContainerName: editor
          ContainerPort: 80
          TargetGroupArn: !Ref EditorTargetGroup

  PublisherService:
    Type: AWS::ECS::Service
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: !If
            - CreateNewVPCCond
            - [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
            - [ !Select [ 0, !Ref PublicSubnets ], !Select [ 1, !Ref PublicSubnets ] ]
          SecurityGroups: [ !Ref PublisherServiceSG ]
      TaskDefinition: !Ref PublisherTaskDefinition
      LoadBalancers:
        - ContainerName: publisher
          ContainerPort: 80
          TargetGroupArn: !Ref PublisherTargetGroup

  EditorDNSRecord:
    Condition: CreateDNSRecords
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref EditorHostName
      Type: A
      AliasTarget:
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        EvaluateTargetHealth: false

  PublisherDNSRecord:
    Condition: CreatePublisherDNS
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref PublisherHostName
      Type: A
      AliasTarget:
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        EvaluateTargetHealth: false

Outputs:
  CreatedVpcId:
    Condition: CreateNewVPCCond
    Description: VPC ID created by this stack (when CreateNewVPC=true)
    Value: !Ref VPC
  PrivateSubnet1Id:
    Condition: PrivateEnabled
    Description: Private Subnet 1 ID (AZ 1)
    Value: !Ref PrivateSubnet1
  PrivateSubnet2Id:
    Condition: PrivateEnabled
    Description: Private Subnet 2 ID (AZ 2)
    Value: !Ref PrivateSubnet2
  LoadBalancerDNSName:
    Description: Public DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
  EditorServiceName:
    Description: ECS service name for Editor
    Value: !Ref EditorService
  PublisherServiceName:
    Description: ECS service name for Publisher
    Value: !Ref PublisherService
  EfsFileSystemId:
    Description: EFS filesystem used for SQLite storage
    Value: !Ref EfsFileSystem
  S3Bucket:
    Description: S3 bucket used for blob storage
    Value: !Ref S3BucketName
  EditorDNSRecordName:
    Condition: CreateDNSRecords
    Description: Route 53 DNS name created for the Editor host (if HostedZoneId provided)
    Value: !Ref EditorHostName
  PublisherDNSRecordName:
    Condition: CreatePublisherDNS
    Description: Route 53 DNS name created for the Publisher host (if HostedZoneId and PublisherHostName provided)
    Value: !Ref PublisherHostName
