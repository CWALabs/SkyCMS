AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy SkyCMS Editor and Publisher on AWS using ECS Fargate, S3 (blob storage), EFS (SQLite persistence), and an Application Load Balancer (host-based routing)

Parameters:
  InstallId:
    Type: String
    Description: A short install name to tag all resources (used as value for tag key 'skycms-install-id')

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the new VPC created by this template

  PublicSubnet1Cidr:
    Type: String
    Default: 10.0.0.0/24
    Description: CIDR for public subnet 1 (AZ 1)

  PublicSubnet2Cidr:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR for public subnet 2 (AZ 2)
  CreatePrivateSubnets:
    Type: String
    AllowedValues: ['true','false']
    Default: 'true'
    Description: When 'true', also create two private subnets and a NAT Gateway for egress (good for databases later)
  StackName:
    Type: String
    Default: skycms
    Description: Logical name prefix for created resources


  S3BucketName:
    Type: String
    Description: S3 bucket name for blob storage

  S3Region:
    Type: String
    Description: AWS region of the S3 bucket (commercial AWS regions)
    AllowedValues:
      # Americas
      - us-east-1      # N. Virginia
      - us-east-2      # Ohio
      - us-west-1      # N. California
      - us-west-2      # Oregon
      - ca-central-1   # Canada (Central)
      - ca-west-1      # Canada West (Calgary)
      - sa-east-1      # South America (Sao Paulo)

      # Europe
      - eu-west-1      # Ireland
      - eu-west-2      # London
      - eu-west-3      # Paris
      - eu-central-1   # Frankfurt
      - eu-central-2   # Zurich
      - eu-north-1     # Stockholm
      - eu-south-1     # Milan
      - eu-south-2     # Spain

      # Asia Pacific
      - ap-south-1     # Mumbai
      - ap-south-2     # Hyderabad
      - ap-southeast-1 # Singapore
      - ap-southeast-2 # Sydney
      - ap-southeast-3 # Jakarta
      - ap-southeast-4 # Melbourne
      - ap-southeast-5 # Malaysia (Kuala Lumpur)
      - ap-northeast-1 # Tokyo
      - ap-northeast-2 # Seoul
      - ap-northeast-3 # Osaka
      - ap-east-1      # Hong Kong

      # Middle East & Africa
      - me-south-1     # Bahrain
      - me-central-1   # UAE (Dubai)
      - me-west-1      # Israel (Tel Aviv)
      - af-south-1     # Cape Town
    Default: us-west-2

  S3AccessKeyId:
    Type: String
    NoEcho: true
    Description: S3 access key ID used by the app to access the bucket

  S3SecretAccessKey:
    Type: String
    NoEcho: true
    Description: S3 secret access key used by the app to access the bucket

  AdminEmailAddress:
    Type: String
    Description: Administrator email for initial account and notifications

  SmtpHostName:
    Type: String
    Default: ''
    Description: SMTP relay host (optional)

  SmtpPort:
    Type: String
    Default: ''
    Description: SMTP port (optional; leave blank to omit)

  SmtpEnableTls:
    Type: String
    Default: ''
    Description: Enable TLS for SMTP (optional; set to 'true' or 'false', leave blank to omit)

  SmtpUserName:
    Type: String
    Default: ''
    Description: SMTP username (optional)

  SmtpPassword:
    Type: String
    NoEcho: true
    Default: ''
    Description: SMTP password (optional)

  SendGridApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: SendGrid API key (optional)

  DesiredCount:
    Type: Number
    Default: 1
    Description: Desired number of ECS tasks for each service

  EditorImage:
    Type: String
    Default: toiyabe/sky-editor:latest
    Description: Container image for the Editor service

  PublisherImage:
    Type: String
    Default: toiyabe/sky-publisher:latest
    Description: Container image for the Publisher service

  ACMCertificateArn:
    Type: String
    Default: ''
    Description: Optional ACM certificate ARN for HTTPS (443) on the load balancer. Leave blank to skip HTTPS.

  EditorHostName:
    Type: String
    Description: Fully qualified host name for the Editor (e.g., editor.example.com)

  PublisherHostName:
    Type: String
    Default: ''
    Description: Optional fully qualified host name for the Publisher (e.g., www.example.com). If blank, default action serves Publisher.

  RedirectHttpToHttps:
    Type: String
    AllowedValues: ['true','false']
    Default: 'false'
    Description: If true and HTTPS is configured, HTTP (80) requests will be redirected to HTTPS (443) with 301.

  AssignPublicIp:
    Type: String
    AllowedValues: [ ENABLED, DISABLED ]
    Default: ENABLED
    Description: Whether to assign a public IP to ECS tasks. Enable if your subnets do not have NAT internet egress.


Mappings: {}

Conditions:
  PrivateEnabled: !Equals [ !Ref CreatePrivateSubnets, 'true' ]
  UseSMTP: !Not [ !Equals [ !Ref SmtpHostName, '' ] ]
  UseSendGrid: !Not [ !Equals [ !Ref SendGridApiKey, '' ] ]
  UseHTTPS: !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ]
  UsePublisherHostName: !Not [ !Equals [ !Ref PublisherHostName, '' ] ]
  RedirectToHTTPS: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Equals [ !Ref RedirectHttpToHttps, 'true' ] ]
  CreateHttpRules: !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ]
  UseHTTPSAndPublisher: !And [ !Not [ !Equals [ !Ref ACMCertificateArn, '' ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]
  CreateHttpRulesAndPublisher: !And [ !Or [ !Equals [ !Ref ACMCertificateArn, '' ], !Not [ !Equals [ !Ref RedirectHttpToHttps, 'true' ] ] ], !Not [ !Equals [ !Ref PublisherHostName, '' ] ] ]
  UseSmtpPort: !And [ !Not [ !Equals [ !Ref SmtpHostName, '' ] ], !Not [ !Equals [ !Ref SmtpPort, '' ] ] ]
  UseSmtpEnableTls: !And [ !Not [ !Equals [ !Ref SmtpHostName, '' ] ], !Not [ !Equals [ !Ref SmtpEnableTls, '' ] ] ]

Resources:
  # VPC with two public subnets and IGW for internet egress
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-vpc"
        - Key: skycms-install-id
          Value: !Ref InstallId

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-igw"
        - Key: skycms-install-id
          Value: !Ref InstallId

  IGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-rt"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: IGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-a"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-public-b"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PubSubnet1RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PubSubnet2RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Private subnets and NAT for future database and private workloads
  NatEip:
    Condition: PrivateEnabled
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-nat-eip"
        - Key: skycms-install-id
          Value: !Ref InstallId

  NatGateway:
    Condition: PrivateEnabled
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId: !Ref PublicSubnet1
      AllocationId: !GetAtt NatEip.AllocationId
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-nat"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateRouteTable:
    Condition: PrivateEnabled
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-rt"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateDefaultRoute:
    Condition: PrivateEnabled
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1:
    Condition: PrivateEnabled
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.100.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-a"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivateSubnet2:
    Condition: PrivateEnabled
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.101.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${StackName}-private-b"
        - Key: skycms-install-id
          Value: !Ref InstallId

  PrivSubnet1RouteAssoc:
    Condition: PrivateEnabled
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivSubnet2RouteAssoc:
    Condition: PrivateEnabled
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for public ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - !If 
          - UseHTTPS
          - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: 0.0.0.0/0 }
          - { Ref: AWS::NoValue }
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${StackName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
      SecurityGroups: [ !Ref ALBSecurityGroup ]
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-pub-tg"
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${StackName}-ed-tg"
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckPath: '/'
      Matcher:
        HttpCode: '200-399'
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - !If
          - RedirectToHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref PublisherTargetGroup

  HttpsListener:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpEditorRule:
    Condition: CreateHttpRules
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup

  HttpPublisherRule:
    Condition: CreateHttpRulesAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup

  HttpsEditorRule:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref EditorHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref EditorTargetGroup
  HttpsPublisherRule:
    Condition: UseHTTPSAndPublisher
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values: [ !Ref PublisherHostName ]
      Actions:
        - Type: forward
          TargetGroupArn: !Ref PublisherTargetGroup
  SqliteConnectionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${StackName}/sqlite/connection"
      Description: SkyCMS SQLite connection string with generated password
      GenerateSecretString:
        SecretStringTemplate: '{"Data Source":"/data/sqlite/skycms.db"}'
        GenerateStringKey: Password
        PasswordLength: 24
        ExcludeCharacters: '"'  # avoid breaking JSON
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ecs/${StackName}"
      RetentionInDays: 14
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EfsFileSystem:
    Type: AWS::EFS::FileSystem
    DeletionPolicy: Retain
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: !Sub "${StackName}-sqlite"
        - Key: skycms-install-id
          Value: !Ref InstallId

  EfsAccessPoint:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: "1000"
        Gid: "1000"
      RootDirectory:
        Path: "/data/sqlite"
        CreationInfo:
          OwnerUid: "1000"
          OwnerGid: "1000"
          Permissions: "0777"
      AccessPointTags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EfsMountSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow NFS for EFS mounts
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref EditorServiceSG
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref PublisherServiceSG
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EfsMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !Ref PublicSubnet1
      SecurityGroups: [ !Ref EfsMountSecurityGroup ]

  EfsMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !Ref PublicSubnet2
      SecurityGroups: [ !Ref EfsMountSecurityGroup ]

  EditorToEfsNfsEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref EditorServiceSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      DestinationSecurityGroupId: !Ref EfsMountSecurityGroup

  PublisherToEfsNfsEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref PublisherServiceSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      DestinationSecurityGroupId: !Ref EfsMountSecurityGroup

  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${StackName}-cluster"
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: s3-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3BucketName}"
                  - !Sub "arn:aws:s3:::${S3BucketName}/*"
        - PolicyName: efs-client
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                Resource:
                  - !Sub "arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:file-system/${EfsFileSystem}"
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                Resource:
                  - !Sub "arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:access-point/${EfsAccessPoint}"
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-editor"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      Volumes:
        - Name: sqlite
          EFSVolumeConfiguration:
            FilesystemId: !Ref EfsFileSystem
            TransitEncryption: ENABLED
            AuthorizationConfig:
              AccessPointId: !Ref EfsAccessPoint
              IAM: ENABLED
            RootDirectory: '/'
      ContainerDefinitions:
        - Name: editor
          Image: !Ref EditorImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosAllowSetup
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:8080'
            - Name: CosmosPublisherUrl
              Value: !If
                - UsePublisherHostName
                - !If
                  - UseHTTPS
                  - !Sub "https://${PublisherHostName}"
                  - !Sub "http://${PublisherHostName}"
                - ''
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: CosmosSendGridApiKey
              Value: !If [ UseSendGrid, !Ref SendGridApiKey, '' ]
            - Name: SmtpEmailProviderOptions__Host
              Value: !If [ UseSMTP, !Ref SmtpHostName, '' ]
            - !If
              - UseSmtpPort
              - { Name: SmtpEmailProviderOptions__Port, Value: !Ref SmtpPort }
              - !Ref 'AWS::NoValue'
            - !If
              - UseSmtpEnableTls
              - { Name: SmtpEmailProviderOptions__EnableSsl, Value: !Ref SmtpEnableTls }
              - !Ref 'AWS::NoValue'
            - Name: SmtpEmailProviderOptions__UserName
              Value: !If [ UseSMTP, !Ref SmtpUserName, '' ]
            - Name: SmtpEmailProviderOptions__Password
              Value: !If [ UseSMTP, !Ref SmtpPassword, '' ]
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Sub 'Data Source=/data/sqlite/skycms.db;Password={{resolve:secretsmanager:${SqliteConnectionSecret}:SecretString:Password}};'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: editor
          MountPoints:
            - ContainerPath: /data/sqlite
              SourceVolume: sqlite
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "${StackName}-publisher"
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities: [ FARGATE ]
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      Volumes:
        - Name: sqlite
          EFSVolumeConfiguration:
            FilesystemId: !Ref EfsFileSystem
            TransitEncryption: ENABLED
            AuthorizationConfig:
              AccessPointId: !Ref EfsAccessPoint
              IAM: ENABLED
            RootDirectory: '/'
      ContainerDefinitions:
        - Name: publisher
          Image: !Ref PublisherImage
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: AdminEmail
              Value: !Ref AdminEmailAddress
            - Name: CosmosStaticWebPages
              Value: 'true'
            - Name: ASPNETCORE_URLS
              Value: 'http://+:8080'
            - Name: AzureBlobStorageEndPoint
              Value: '/'
            - Name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
              Value: 'false'
            - Name: CosmosSendGridApiKey
              Value: !If [ UseSendGrid, !Ref SendGridApiKey, '' ]
            - Name: SmtpEmailProviderOptions__Host
              Value: !If [ UseSMTP, !Ref SmtpHostName, '' ]
            - !If
              - UseSmtpPort
              - { Name: SmtpEmailProviderOptions__Port, Value: !Ref SmtpPort }
              - !Ref 'AWS::NoValue'
            - !If
              - UseSmtpEnableTls
              - { Name: SmtpEmailProviderOptions__EnableSsl, Value: !Ref SmtpEnableTls }
              - !Ref 'AWS::NoValue'
            - Name: SmtpEmailProviderOptions__UserName
              Value: !If [ UseSMTP, !Ref SmtpUserName, '' ]
            - Name: SmtpEmailProviderOptions__Password
              Value: !If [ UseSMTP, !Ref SmtpPassword, '' ]
            - Name: ConnectionStrings__ApplicationDbContextConnection
              Value: !Sub 'Data Source=/data/sqlite/skycms.db;Password={{resolve:secretsmanager:${SqliteConnectionSecret}:SecretString:Password}};'
            - Name: ConnectionStrings__StorageConnectionString
              Value: !Sub 'Bucket=${S3BucketName};Region=${S3Region};KeyId=${S3AccessKeyId};Key=${S3SecretAccessKey};'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: publisher
          MountPoints:
            - ContainerPath: /data/sqlite
              SourceVolume: sqlite
          LinuxParameters:
            InitProcessEnabled: true
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP to Editor ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP to Publisher ECS service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  EditorService:
    Type: AWS::ECS::Service
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
          SecurityGroups: [ !Ref EditorServiceSG ]
      TaskDefinition: !Ref EditorTaskDefinition
      LoadBalancers:
        - ContainerName: editor
          ContainerPort: 8080
          TargetGroupArn: !Ref EditorTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId

  PublisherService:
    Type: AWS::ECS::Service
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - HttpListener
    Properties:
      Cluster: !Ref EcsCluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
          SecurityGroups: [ !Ref PublisherServiceSG ]
      TaskDefinition: !Ref PublisherTaskDefinition
      LoadBalancers:
        - ContainerName: publisher
          ContainerPort: 8080
          TargetGroupArn: !Ref PublisherTargetGroup
      Tags:
        - Key: skycms-install-id
          Value: !Ref InstallId


Outputs:
  CreatedVpcId:
    Description: VPC ID created by this stack
    Value: !Ref VPC
  PrivateSubnet1Id:
    Condition: PrivateEnabled
    Description: Private Subnet 1 ID (AZ 1)
    Value: !Ref PrivateSubnet1
  PrivateSubnet2Id:
    Condition: PrivateEnabled
    Description: Private Subnet 2 ID (AZ 2)
    Value: !Ref PrivateSubnet2
  LoadBalancerDNSName:
    Description: Public DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
  EditorServiceName:
    Description: ECS service name for Editor
    Value: !Ref EditorService
  PublisherServiceName:
    Description: ECS service name for Publisher
    Value: !Ref PublisherService
  EfsFileSystemId:
    Description: EFS filesystem used for SQLite storage
    Value: !Ref EfsFileSystem
  S3Bucket:
    Description: S3 bucket used for blob storage
    Value: !Ref S3BucketName
