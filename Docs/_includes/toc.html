<nav class="toc" role="doc-toc" aria-label="On this page">
  <div class="toc-header">
    <p class="toc-title">On this page</p>
    <button type="button" class="toc-toggle" data-state="expanded">Collapse all</button>
  </div>
  <ul class="toc-list" id="toc-list"></ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tocList = document.getElementById('toc-list');
  if (!tocList) return;

  const docMain = document.querySelector('.doc-main');
  if (!docMain) return;

  const slugify = (text) => text
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-');

  const headings = document.querySelectorAll('.doc-main h2, .doc-main h3, .doc-main h4');
  if (!headings.length) return;

  let currentDetails = null;
  let currentSubDetails = null;

  headings.forEach((el) => {
    const level = el.tagName.toLowerCase();
    const text = (el.textContent || '').trim();
    if (!text) return;

    if (!el.id) {
      el.id = slugify(text);
    }

    if (level === 'h2') {
      const li = document.createElement('li');
      const details = document.createElement('details');
      details.open = true;
      const summary = document.createElement('summary');
      const link = document.createElement('a');
      link.href = `#${el.id}`;
      link.textContent = text;
      summary.appendChild(link);
      details.appendChild(summary);
      const childList = document.createElement('ul');
      childList.className = 'toc-sublist';
      details.appendChild(childList);
      li.appendChild(details);
      tocList.appendChild(li);
      currentDetails = details;
      currentSubDetails = null;
    } else if (level === 'h3' && currentDetails) {
      const subList = currentDetails.querySelector('.toc-sublist');
      if (!subList) return;
      const subLi = document.createElement('li');
      const subDetails = document.createElement('details');
      subDetails.open = true;
      const summary = document.createElement('summary');
      const link = document.createElement('a');
      link.href = `#${el.id}`;
      link.textContent = text;
      summary.appendChild(link);
      subDetails.appendChild(summary);
      const h4List = document.createElement('ul');
      h4List.className = 'toc-subsublist';
      subDetails.appendChild(h4List);
      subLi.appendChild(subDetails);
      subList.appendChild(subLi);
      currentSubDetails = subDetails;
    } else if (level === 'h4' && currentSubDetails) {
      const h4List = currentSubDetails.querySelector('.toc-subsublist');
      if (!h4List) return;
      const h4Li = document.createElement('li');
      const link = document.createElement('a');
      link.href = `#${el.id}`;
      link.textContent = text;
      h4Li.appendChild(link);
      h4List.appendChild(h4Li);
    }
  });

  const toggleBtn = document.querySelector('.toc-toggle');
  if (!toggleBtn) return;

  toggleBtn.addEventListener('click', () => {
    const details = tocList.querySelectorAll('details');
    const shouldCollapse = toggleBtn.getAttribute('data-state') === 'expanded';
    details.forEach(d => { d.open = !shouldCollapse; });
    toggleBtn.textContent = shouldCollapse ? 'Expand all' : 'Collapse all';
    toggleBtn.setAttribute('data-state', shouldCollapse ? 'collapsed' : 'expanded');
  });
  // Expand current section on scroll
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const id = entry.target.id;
      if (!id) return;
      const link = tocList.querySelector(`a[href="#${id}"]`);
      if (!link) return;

      // Expand enclosing details
      const detailsEls = link.closest('details');
      if (detailsEls) {
        detailsEls.open = true;
        const parentDetails = detailsEls.parentElement?.closest('details');
        if (parentDetails) parentDetails.open = true;
      }

      // Active state
      const allLinks = tocList.querySelectorAll('a');
      allLinks.forEach(a => a.classList.remove('is-active'));
      link.classList.add('is-active');
    });
  }, { rootMargin: '0px 0px -60% 0px', threshold: 0.1 });

  headings.forEach(h => observer.observe(h));
});
</script>
