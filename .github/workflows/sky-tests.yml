name: Sky.Tests

# This workflow runs only when manually triggered
on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter (optional, leave empty for all tests)'
        required: false
        type: string
        default: ''
      
      verbosity:
        description: 'Test output verbosity'
        required: false
        default: 'normal'
        type: choice
        options:
          - quiet
          - minimal
          - normal
          - detailed
          - diagnostic

jobs:
  sky-tests:
    name: Run Sky.Tests
    runs-on: ubuntu-latest

services:
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.20.0
    ports:
      - 10000:10000
      - 10001:10001
      - 10002:10002
    options: >-
      --health-cmd "curl --fail http://localhost:10000/health || exit 1"
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Display test configuration
      run: |
        echo "🔧 Test Configuration:"
        echo "  Test Filter: ${{ inputs.test_filter || 'All tests' }}"
        echo "  Verbosity: ${{ inputs.verbosity }}"
        
    - name: Restore dependencies
      run: dotnet restore Tests/Sky.Tests.csproj
      
    - name: Build Sky.Tests
      run: dotnet build Tests/Sky.Tests.csproj --no-restore --configuration Release
      
    - name: Run Sky.Tests (All tests)
      if: ${{ inputs.test_filter == '' }}
      env:
        # CRITICAL: These environment variable names must match what your PowerShell script uploads
        # The double underscores (__) map to nested config in .NET (ConnectionStrings:StorageConnectionString)
        
        ADMINEMAIL: ${{ secrets.ADMINEMAIL }}
        COSMOSIDENTITYDBNAME: ${{ secrets.COSMOSIDENTITYDBNAME }}

        # Azurite connection string (using service container)
        CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://localhost:10000/devstoreaccount1;"

        # Storage Connections
        # CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__STORAGECONNECTIONSTRING }}
        # CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING }}
        CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING }}
        
        # Database Connections (using live Azure databases)
        CONNECTIONSTRINGS__COSMOSDB: ${{ secrets.CONNECTIONSTRINGS__COSMOSDB }}
        CONNECTIONSTRINGS__SQLSERVER: ${{ secrets.CONNECTIONSTRINGS__SQLSERVER }}
        CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
        # SQLite: Excluded from CI/CD tests
        # CONNECTIONSTRINGS__SQLITE: ${{ secrets.CONNECTIONSTRINGS__SQLITE }}
        
        # CDN Integration Tests
        CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN }}
      run: |
        dotnet test Tests/Sky.Tests.csproj \
          --no-build \
          --configuration Release \
          --logger "console;verbosity=${{ inputs.verbosity }}" \
          --logger "trx;LogFileName=sky-test-results.trx" \
          --logger "html;LogFileName=sky-test-results.html" \
          --results-directory ./TestResults
      
    - name: Run Sky.Tests (Filtered)
      if: ${{ inputs.test_filter != '' }}
      env:
        # CRITICAL: These environment variable names must match what your PowerShell script uploads
        # The double underscores (__) map to nested config in .NET (ConnectionStrings:StorageConnectionString)
        
        ADMINEMAIL: ${{ secrets.ADMINEMAIL }}
        COSMOSIDENTITYDBNAME: ${{ secrets.COSMOSIDENTITYDBNAME }}

        # Storage Connections
        CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__STORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING }}
        CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING }}
        
        # Database Connections (using live Azure databases)
        CONNECTIONSTRINGS__COSMOSDB: ${{ secrets.CONNECTIONSTRINGS__COSMOSDB }}
        CONNECTIONSTRINGS__SQLSERVER: ${{ secrets.CONNECTIONSTRINGS__SQLSERVER }}
        CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
        # SQLite: Excluded from CI/CD tests
        # CONNECTIONSTRINGS__SQLITE: ${{ secrets.CONNECTIONSTRINGS__SQLITE }}
        
        # CDN Integration Tests
        CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN }}
      run: |
        dotnet test Tests/Sky.Tests.csproj \
          --no-build \
          --configuration Release \
          --filter "${{ inputs.test_filter }}" \
          --logger "console;verbosity=${{ inputs.verbosity }}" \
          --logger "trx;LogFileName=sky-test-results.trx" \
          --logger "html;LogFileName=sky-test-results.html" \
          --results-directory ./TestResults
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sky-test-results-${{ github.run_number }}
        path: ./TestResults/
        retention-days: 30
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## 🧪 Sky.Tests Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Test Filter: \`${{ inputs.test_filter || 'All tests' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Verbosity: \`${{ inputs.verbosity }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Status: **${{ job.status }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### ✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Areas Covered:**" >> $GITHUB_STEP_SUMMARY
        echo "- 📝 **Articles & Content:**" >> $GITHUB_STEP_SUMMARY
        echo "  - Article creation, editing, and publishing" >> $GITHUB_STEP_SUMMARY
        echo "  - Title changes and URL redirects" >> $GITHUB_STEP_SUMMARY
        echo "  - Article scheduling" >> $GITHUB_STEP_SUMMARY
        echo "  - Blog rendering" >> $GITHUB_STEP_SUMMARY
        echo "- 🎨 **Templates & Layouts:**" >> $GITHUB_STEP_SUMMARY
        echo "  - Template management" >> $GITHUB_STEP_SUMMARY
        echo "  - Layout import and export" >> $GITHUB_STEP_SUMMARY
        echo "- 📦 **Storage:**" >> $GITHUB_STEP_SUMMARY
        echo "  - Azure Blob Storage" >> $GITHUB_STEP_SUMMARY
        echo "  - Amazon S3" >> $GITHUB_STEP_SUMMARY
        echo "  - Cloudflare R2" >> $GITHUB_STEP_SUMMARY
        echo "- 🗄️ **Databases:**" >> $GITHUB_STEP_SUMMARY
        echo "  - CosmosDB" >> $GITHUB_STEP_SUMMARY
        echo "  - SQL Server" >> $GITHUB_STEP_SUMMARY
        echo "  - MySQL" >> $GITHUB_STEP_SUMMARY
        echo "- 🌐 **CDN Integration:**" >> $GITHUB_STEP_SUMMARY
        echo "  - Cloudflare CDN" >> $GITHUB_STEP_SUMMARY
        echo "  - Cache purging" >> $GITHUB_STEP_SUMMARY
        echo "- 🔐 **Security & Authentication:**" >> $GITHUB_STEP_SUMMARY
        echo "  - User management" >> $GITHUB_STEP_SUMMARY
        echo "  - Role management" >> $GITHUB_STEP_SUMMARY
        echo "  - Authorization policies" >> $GITHUB_STEP_SUMMARY
        echo "- 🎯 **Feature Tests:**" >> $GITHUB_STEP_SUMMARY
        echo "  - Vertical Slice Architecture handlers" >> $GITHUB_STEP_SUMMARY
        echo "  - Domain event dispatching" >> $GITHUB_STEP_SUMMARY
        echo "  - Catalog service" >> $GITHUB_STEP_SUMMARY
        echo "  - Reserved paths" >> $GITHUB_STEP_SUMMARY