name: Advanced Connectivity Tests

on:
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: true
        default: 'All'
        type: choice
        options:
          - All
          - Database
          - Storage
          - Connectivity
      
      specific_test:
        description: 'Specific test method name (optional, leave empty for all in category)'
        required: false
        type: string
        default: ''
      
      verbosity:
        description: 'Test output verbosity'
        required: false
        default: 'normal'
        type: choice
        options:
          - quiet
          - minimal
          - normal
          - detailed
          - diagnostic

jobs:
  connectivity-check:
    name: Connectivity Tests - ${{ inputs.test_category }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Display test configuration
      run: |
        echo "ðŸ”§ Test Configuration:"
        echo "  Category: ${{ inputs.test_category }}"
        echo "  Specific Test: ${{ inputs.specific_test || 'All tests in category' }}"
        echo "  Verbosity: ${{ inputs.verbosity }}"
        
    - name: Restore dependencies
      run: dotnet restore Sky.TestSetup/Sky.TestSetup.csproj
      
    - name: Build Sky.TestSetup
      run: dotnet build Sky.TestSetup/Sky.TestSetup.csproj --no-restore --configuration Release
      
    - name: Run connectivity tests (All categories)
      if: ${{ inputs.test_category == 'All' && inputs.specific_test == '' }}
      env:
        ADMINEMAIL: ${{ secrets.ADMINEMAIL }}
        COSMOSIDENTITYDBNAME: ${{ secrets.COSMOSIDENTITYDBNAME }}
        CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__STORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING }}
        CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING }}
        CONNECTIONSTRINGS__COSMOSDB: ${{ secrets.CONNECTIONSTRINGS__COSMOSDB }}
        CONNECTIONSTRINGS__SQLSERVER: ${{ secrets.CONNECTIONSTRINGS__SQLSERVER }}
        CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN }}
      run: |
        dotnet test Sky.TestSetup/Sky.TestSetup.csproj \
          --no-build \
          --configuration Release \
          --logger "console;verbosity=${{ inputs.verbosity }}" \
          --logger "trx;LogFileName=connectivity-test-results.trx" \
          --logger "html;LogFileName=connectivity-test-results.html" \
          --results-directory ./TestResults
      
    - name: Run connectivity tests (Specific category)
      if: ${{ inputs.test_category != 'All' && inputs.specific_test == '' }}
      env:
        ADMINEMAIL: ${{ secrets.ADMINEMAIL }}
        COSMOSIDENTITYDBNAME: ${{ secrets.COSMOSIDENTITYDBNAME }}
        CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__STORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING }}
        CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING }}
        CONNECTIONSTRINGS__COSMOSDB: ${{ secrets.CONNECTIONSTRINGS__COSMOSDB }}
        CONNECTIONSTRINGS__SQLSERVER: ${{ secrets.CONNECTIONSTRINGS__SQLSERVER }}
        CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN }}
      run: |
        dotnet test Sky.TestSetup/Sky.TestSetup.csproj \
          --no-build \
          --configuration Release \
          --filter "TestCategory=${{ inputs.test_category }}" \
          --logger "console;verbosity=${{ inputs.verbosity }}" \
          --logger "trx;LogFileName=connectivity-test-results.trx" \
          --logger "html;LogFileName=connectivity-test-results.html" \
          --results-directory ./TestResults
      
    - name: Run specific test
      if: ${{ inputs.specific_test != '' }}
      env:
        ADMINEMAIL: ${{ secrets.ADMINEMAIL }}
        COSMOSIDENTITYDBNAME: ${{ secrets.COSMOSIDENTITYDBNAME }}
        CONNECTIONSTRINGS__STORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__STORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AZUREBLOBSTORAGECONNECTIONSTRING }}
        CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__AMAZONS3CONNECTIONSTRING }}
        CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING: ${{ secrets.CONNECTIONSTRINGS__CLOUDFLARER2CONNECTIONSTRING }}
        CONNECTIONSTRINGS__COSMOSDB: ${{ secrets.CONNECTIONSTRINGS__COSMOSDB }}
        CONNECTIONSTRINGS__SQLSERVER: ${{ secrets.CONNECTIONSTRINGS__SQLSERVER }}
        CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__APITOKEN }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__ZONEID }}
        CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN: ${{ secrets.CDNINTEGRATIONTESTS__CLOUDFLARE__TESTDOMAIN }}
      run: |
        dotnet test Sky.TestSetup/Sky.TestSetup.csproj \
          --no-build \
          --configuration Release \
          --filter "FullyQualifiedName~${{ inputs.specific_test }}" \
          --logger "console;verbosity=${{ inputs.verbosity }}" \
          --logger "trx;LogFileName=connectivity-test-results.trx" \
          --logger "html;LogFileName=connectivity-test-results.html" \
          --results-directory ./TestResults
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: connectivity-test-results-${{ github.run_number }}
        path: ./TestResults/
        retention-days: 30
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## ðŸ”Œ Connectivity Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Test Category: \`${{ inputs.test_category }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Specific Test: \`${{ inputs.specific_test || 'All tests in category' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Verbosity: \`${{ inputs.verbosity }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Status: **${{ job.status }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Services Tested:**" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.test_category }}" == "All" ] || [ "${{ inputs.test_category }}" == "Database" ]; then
          echo "- ðŸ—„ï¸ **Databases:**" >> $GITHUB_STEP_SUMMARY
          echo "  - CosmosDB" >> $GITHUB_STEP_SUMMARY
          echo "  - SQL Server" >> $GITHUB_STEP_SUMMARY
          echo "  - MySQL" >> $GITHUB_STEP_SUMMARY
          echo "  - SQLite _(excluded from CI/CD)_" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ inputs.test_category }}" == "All" ] || [ "${{ inputs.test_category }}" == "Storage" ]; then
          echo "- ðŸ“¦ **Storage:**" >> $GITHUB_STEP_SUMMARY
          echo "  - Azure Blob Storage" >> $GITHUB_STEP_SUMMARY
          echo "  - Amazon S3" >> $GITHUB_STEP_SUMMARY
          echo "  - Cloudflare R2" >> $GITHUB_STEP_SUMMARY
        fi
